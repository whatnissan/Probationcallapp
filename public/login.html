<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - ProbationCall</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#0a0a0f;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center}
.container{text-align:center;padding:40px}
.logo{font-size:3rem;margin-bottom:10px}
h1{color:#00d9ff;margin-bottom:10px}
p{color:#8892b0;margin-bottom:30px}
.btn{display:inline-flex;align-items:center;gap:10px;background:#fff;color:#000;border:none;padding:14px 28px;border-radius:8px;font-size:1rem;font-weight:600;cursor:pointer}
.btn:hover{background:#eee}
.btn img{width:20px;height:20px}
.loading{display:none;color:#8892b0;margin-top:20px}
.spinner{width:30px;height:30px;border:3px solid #333;border-top-color:#00d9ff;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}
.status{margin-top:20px;padding:10px;border-radius:8px;font-size:0.9rem}
.status.error{background:rgba(239,68,68,0.2);color:#ef4444}
</style>
</head>
<body>
<div class="container">
<div class="logo">ðŸ“ž</div>
<h1>ProbationCall</h1>
<p>Sign in to manage your automated calls</p>
<button class="btn" id="loginBtn" onclick="login()">
<img src="https://www.google.com/favicon.ico" alt="Google">
Sign in with Google
</button>
<div class="loading" id="loading">
<div class="spinner"></div>
<div>Signing you in...</div>
</div>
<div class="status" id="status" style="display:none"></div>
</div>

<script>
var SUPA_URL = 'https://xvpuqeaowvlkcyywgaaq.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cHVxZWFvd3Zsa2N5eXdnYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzc1MjcsImV4cCI6MjA3OTg1MzUyN30.y90odNDSU0zZcVGMK9C39gSFDL9NJcy5E4yBkgcFc8w';
var supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);

// Check if returning from OAuth with token in URL
async function handleOAuthCallback() {
  // Check for hash fragment (OAuth callback)
  if (window.location.hash && window.location.hash.includes('access_token')) {
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    
    // Let Supabase handle the hash automatically
    await new Promise(function(r) { setTimeout(r, 1000); });
    
    var result = await supabase.auth.getSession();
    if (result.data.session) {
      window.location.href = '/dashboard';
    } else {
      // Try one more time
      await new Promise(function(r) { setTimeout(r, 1000); });
      result = await supabase.auth.getSession();
      if (result.data.session) {
        window.location.href = '/dashboard';
      } else {
        showError('Login failed. Please try again.');
      }
    }
    return true;
  }
  return false;
}

// Check if already logged in
async function checkExistingSession() {
  // Don't auto-redirect if user explicitly came to login or already redirecting
  var params = new URLSearchParams(window.location.search);
  if (params.get('logout') === 'true') {
    sessionStorage.removeItem('redirecting');
    await supabase.auth.signOut();
    return false;
  }
  
  if (sessionStorage.getItem('redirecting')) {
    sessionStorage.removeItem('redirecting');
    return false;
  }
  
  var result = await supabase.auth.getSession();
  if (result.data.session) {
    sessionStorage.setItem('redirecting', 'true');
    window.location.href = '/dashboard';
    return true;
  }
  return false;
}

function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('loginBtn').style.display = 'inline-flex';
  var status = document.getElementById('status');
  status.style.display = 'block';
  status.className = 'status error';
  status.textContent = msg;
}

async function login() {
  console.log('Login clicked');
  try {
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('loading').style.display = 'block';
    document.getElementById('status').style.display = 'none';
    
    console.log('Calling signInWithOAuth...');
    var result = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: {
        queryParams: { prompt: 'select_account' },
        redirectTo: window.location.origin + '/login'
      }
    });
    
    console.log('OAuth result:', result);
    if (result.error) {
      console.error('OAuth error:', result.error);
      showError(result.error.message);
    }
  } catch(e) {
    console.error('Login exception:', e);
    showError(e.message);
  }
}

// Listen for auth state changes - only redirect on new sign in, not page load
supabase.auth.onAuthStateChange(function(event, session) {
  console.log('Auth event:', event);
  if (event === 'SIGNED_IN' && session && !sessionStorage.getItem('redirecting')) {
    sessionStorage.setItem('redirecting', 'true');
    window.location.href = '/dashboard';
  }
});

// Initialize
async function init() {
  // First check if this is an OAuth callback
  var isCallback = await handleOAuthCallback();
  if (isCallback) return;
  
  // Otherwise check if already logged in
  await checkExistingSession();
}

init();
</script>
</body>
</html>
