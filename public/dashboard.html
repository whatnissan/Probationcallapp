<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ProbationCall</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0a0a0f; color: #fff; min-height: 100vh; }
    .loading { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 1.2rem; color: #8892b0; }
    .container { max-width: 700px; margin: 0 auto; padding: 20px; display: none; }
    nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .logo { font-size: 1.3rem; font-weight: 700; color: #00d9ff; }
    .logout-btn { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    .credits-card { background: linear-gradient(135deg, #00d9ff, #00b4d8); border-radius: 16px; padding: 25px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
    .credits-num { font-size: 2.5rem; font-weight: 700; color: #0a0a0f; }
    .credits-label { color: rgba(0,0,0,0.6); font-size: 0.9rem; }
    .buy-btn { background: #0a0a0f; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 30px; margin-bottom: 20px; }
    .card h2 { margin-bottom: 8px; color: #00d9ff; font-size: 1.4rem; }
    .card-subtitle { color: #8892b0; font-size: 0.9rem; margin-bottom: 20px; }
    .schedule-badge { display: inline-block; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-bottom: 20px; }
    .schedule-badge.active { background: rgba(107,203,119,0.2); color: #6bcb77; }
    .schedule-badge.inactive { background: rgba(255,107,107,0.2); color: #ff6b6b; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
    .form-group { margin-bottom: 15px; }
    label { display: block; margin-bottom: 6px; color: #8892b0; font-size: 0.9rem; font-weight: 500; }
    input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: #fff; font-size: 1rem; }
    input:focus { outline: none; border-color: #00d9ff; }
    input:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-group { display: flex; gap: 10px; margin-top: 20px; }
    .btn { flex: 1; padding: 14px; border-radius: 8px; border: none; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary { background: linear-gradient(135deg, #00d9ff, #00b4d8); color: #0a0a0f; }
    .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
    .btn-danger { background: linear-gradient(135deg, #ff6b6b, #ff5252); color: #fff; }
    .divider { height: 1px; background: rgba(255,255,255,0.1); margin: 25px 0; }
    .status { padding: 15px; border-radius: 8px; margin-top: 15px; text-align: center; font-weight: 500; }
    .status.success { background: rgba(107,203,119,0.2); color: #6bcb77; }
    .status.error { background: rgba(255,107,107,0.2); color: #ff6b6b; }
    .status.calling { background: rgba(0,217,255,0.2); color: #00d9ff; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: #1a1a2e; border-radius: 16px; padding: 30px; max-width: 500px; width: 90%; }
    .modal h3 { margin-bottom: 20px; color: #00d9ff; }
    .package { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.2s; }
    .package:hover { background: rgba(0,217,255,0.1); border-color: #00d9ff; }
    .package-name { font-size: 1.2rem; font-weight: 600; margin-bottom: 5px; }
    .package-price { color: #00d9ff; font-size: 1.5rem; font-weight: 700; }
    .package-credits { color: #8892b0; font-size: 0.9rem; }
    .close-modal { background: rgba(255,255,255,0.1); border: none; color: #fff; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-top: 15px; width: 100%; }
    @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } .btn-group { flex-direction: column; } }
  </style>
</head>
<body>
  <div class="loading" id="loading">Loading...</div>
  <div class="container" id="app">
    <nav><div class="logo">üìû ProbationCall</div><button class="logout-btn" onclick="logout()">Sign Out (<span id="email"></span>)</button></nav>
    <div class="credits-card"><div><div class="credits-num" id="credits">0</div><div class="credits-label">Credits Available</div></div><button class="buy-btn" onclick="showBuyModal()">Buy Credits</button></div>
    <div class="card">
      <h2>üìû Call Settings</h2>
      <p class="card-subtitle">Configure your probation hotline calls</p>
      <div id="scheduleBadge" class="schedule-badge inactive">‚è∞ No Schedule Set</div>
      <form onsubmit="handleSubmit(event)">
        <div class="form-group"><label>Probation Hotline Number</label><input type="tel" id="targetNumber" value="+19362834848" disabled></div>
        <div class="form-row">
          <div class="form-group"><label>6-Digit PIN</label><input type="text" id="pin" maxlength="6" placeholder="123456" required></div>
          <div class="form-group"><label>Your WhatsApp</label><input type="tel" id="notify" placeholder="+1234567890" required></div>
        </div>
        <div class="divider"></div>
        <div class="form-row">
          <div class="form-group"><label>Daily Call Time - Hour (0-23)</label><input type="number" id="schedHour" min="0" max="23" placeholder="9"></div>
          <div class="form-group"><label>Daily Call Time - Minute (0-59)</label><input type="number" id="schedMinute" min="0" max="59" placeholder="0"></div>
        </div>
        <div class="btn-group">
          <button type="submit" class="btn btn-primary" id="callNowBtn">üìû Call Now (1 Credit)</button>
          <button type="button" class="btn btn-secondary" id="saveScheduleBtn" onclick="saveSchedule()">üíæ Save Schedule</button>
        </div>
        <button type="button" class="btn btn-danger" id="deleteScheduleBtn" onclick="deleteSchedule()" style="display:none; margin-top: 10px; width: 100%;">üóëÔ∏è Delete Schedule</button>
      </form>
      <div id="status" class="status" style="display:none"></div>
    </div>
  </div>
  <div class="modal" id="buyModal">
    <div class="modal-content">
      <h3>Buy Credits</h3>
      <div class="package" onclick="buyPackage('starter')"><div class="package-name">Starter</div><div class="package-price">$9.99</div><div class="package-credits">30 Credits</div></div>
      <div class="package" onclick="buyPackage('standard')"><div class="package-name">Standard</div><div class="package-price">$24.99</div><div class="package-credits">90 Credits</div></div>
      <div class="package" onclick="buyPackage('value')"><div class="package-name">Value</div><div class="package-price">$39.99</div><div class="package-credits">180 Credits</div></div>
      <button class="close-modal" onclick="closeBuyModal()">Close</button>
    </div>
  </div>
<script>
const SUPA_URL='https://xvpuqeaowvlkcyywgaaq.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cHVxZWFvd3Zsa2N5eXdnYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzc1MjcsImV4cCI6MjA3OTg1MzUyN30.y90odNDSU0zZcVGMK9C39gSFDL9NJcy5E4yBkgcFc8w';
const supabase=window.supabase.createClient(SUPA_URL,SUPA_KEY);
let accessToken=null;
let currentSchedule=null;
async function checkAuth(){const hash=window.location.hash;if(hash&&hash.includes('access_token')){await new Promise(r=>setTimeout(r,1000));history.replaceState(null,'',window.location.pathname+window.location.search);}const {data}=await supabase.auth.getSession();if(data.session){accessToken=data.session.access_token;showApp(data.session.user);const params=new URLSearchParams(window.location.search);if(params.get('success')==='true'){showStatus('Payment successful! Credits added.','success');loadUserData();}}else{window.location.href='/login';}}
function showApp(user){document.getElementById('loading').style.display='none';document.getElementById('app').style.display='block';document.getElementById('email').textContent=user.email;loadUserData();}
async function loadUserData(){try{const r=await fetch('/api/user',{headers:{'Authorization':'Bearer '+accessToken}});const d=await r.json();document.getElementById('credits').textContent=d.profile?d.profile.credits:0;if(d.schedule){currentSchedule=d.schedule;document.getElementById('pin').value=d.schedule.pin;document.getElementById('notify').value=d.schedule.notify_number;document.getElementById('schedHour').value=d.schedule.hour;document.getElementById('schedMinute').value=d.schedule.minute;const timeStr=d.schedule.hour+':'+String(d.schedule.minute).padStart(2,'0');document.getElementById('scheduleBadge').textContent='‚úÖ Daily at '+timeStr;document.getElementById('scheduleBadge').className='schedule-badge active';document.getElementById('deleteScheduleBtn').style.display='block';}else{document.getElementById('scheduleBadge').textContent='‚è∞ No Schedule Set';document.getElementById('scheduleBadge').className='schedule-badge inactive';document.getElementById('deleteScheduleBtn').style.display='none';}}catch(e){console.error(e);}}
function handleSubmit(e){e.preventDefault();makeCallNow();}
async function makeCallNow(){const btn=document.getElementById('callNowBtn');btn.disabled=true;btn.textContent='Calling...';showStatus('Calling hotline...','calling');try{const r=await fetch('/api/call',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+accessToken},body:JSON.stringify({targetNumber:document.getElementById('targetNumber').value,pin:document.getElementById('pin').value,notifyNumber:document.getElementById('notify').value})});const d=await r.json();if(d.error){showStatus('Error: '+d.error,'error');}else{showStatus('‚úÖ Call started! Check WhatsApp for results.','success');loadUserData();}}catch(err){showStatus('Error: '+err.message,'error');}btn.disabled=false;btn.textContent='üìû Call Now (1 Credit)';}
async function saveSchedule(){const hour=document.getElementById('schedHour').value;const minute=document.getElementById('schedMinute').value;if(!hour||!minute){alert('Please enter both hour and minute for the schedule');return;}const btn=document.getElementById('saveScheduleBtn');btn.disabled=true;btn.textContent='Saving...';try{const r=await fetch('/api/schedule',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+accessToken},body:JSON.stringify({targetNumber:document.getElementById('targetNumber').value,pin:document.getElementById('pin').value,notifyNumber:document.getElementById('notify').value,hour:parseInt(hour),minute:parseInt(minute),enabled:true})});const d=await r.json();if(d.success){showStatus('‚úÖ Schedule saved! Daily calls at '+hour+':'+String(minute).padStart(2,'0'),'success');loadUserData();}else{showStatus('Error: '+d.error,'error');}}catch(err){showStatus('Error: '+err.message,'error');}btn.disabled=false;btn.textContent='üíæ Save Schedule';}
async function deleteSchedule(){if(!confirm('Delete your daily schedule?'))return;try{const r=await fetch('/api/schedule',{method:'DELETE',headers:{'Authorization':'Bearer '+accessToken}});const d=await r.json();if(d.success){showStatus('‚úÖ Schedule deleted','success');document.getElementById('schedHour').value='';document.getElementById('schedMinute').value='';currentSchedule=null;loadUserData();}}catch(err){showStatus('Error: '+err.message,'error');}}
function showStatus(message,type){const status=document.getElementById('status');status.style.display='block';status.className='status '+type;status.textContent=message;}
function showBuyModal(){document.getElementById('buyModal').classList.add('show');}
function closeBuyModal(){document.getElementById('buyModal').classList.remove('show');}
async function buyPackage(packageId){try{const r=await fetch('/api/checkout',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+accessToken},body:JSON.stringify({packageId})});const d=await r.json();if(d.url){window.location.href=d.url;}else{alert('Error: '+d.error);}}catch(e){alert('Error: '+e.message);}}
async function logout(){await supabase.auth.signOut();window.location.href='/';}
checkAuth();
</script>
</body>
</html>