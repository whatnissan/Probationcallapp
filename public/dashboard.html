<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - ProbationCall</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#0a0a0f;color:#fff;min-height:100vh}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:15px}
.spinner{width:40px;height:40px;border:3px solid #333;border-top-color:#00d9ff;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.container{max-width:800px;margin:0 auto;padding:20px;display:none}
nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1)}
.logo{font-size:1.2rem;font-weight:700;color:#00d9ff}
.nav-right{display:flex;align-items:center;gap:10px}
.dev-badge{background:#f59e0b;color:#000;padding:4px 8px;border-radius:4px;font-size:0.7rem;font-weight:700}
.logout-btn{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer}
.credits-card{background:linear-gradient(135deg,#00d9ff,#0099cc);border-radius:12px;padding:20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
.credits-num{font-size:2.2rem;font-weight:700;color:#000}
.credits-label{color:rgba(0,0,0,0.6);font-size:0.85rem}
.buy-btn{background:#000;color:#fff;border:none;padding:12px 20px;border-radius:8px;font-weight:600;cursor:pointer}
.schedule-banner{background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:12px;padding:15px 20px;margin-bottom:20px;display:none}
.schedule-banner.active{display:flex;justify-content:space-between;align-items:center}
.schedule-banner h3{color:#000;font-size:1rem;margin-bottom:3px}
.schedule-banner p{color:rgba(0,0,0,0.7);font-size:0.85rem}
.schedule-banner .time{font-size:1.5rem;font-weight:700;color:#000}
.no-schedule{background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);border-radius:12px;padding:15px;margin-bottom:20px;color:#f59e0b;display:none}
.no-schedule.active{display:block}
.card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;margin-bottom:15px}
.card h2{color:#00d9ff;margin-bottom:15px;font-size:1.1rem}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:5px;color:#8892b0;font-size:0.85rem}
input,select{width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff;font-size:1rem}
.btn{width:100%;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#00d9ff,#0099cc);color:#000;font-size:1rem;font-weight:600;cursor:pointer;margin-top:8px}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
.btn-danger{background:#ef4444}
.status{padding:12px;border-radius:8px;margin-top:12px;text-align:center}
.status.success{background:rgba(34,197,94,0.2);color:#22c55e}
.status.error{background:rgba(239,68,68,0.2);color:#ef4444}
.status.calling{background:rgba(0,217,255,0.2);color:#00d9ff}
.status.retry{background:rgba(245,158,11,0.2);color:#f59e0b}
.console{background:#000;border:1px solid #333;border-radius:8px;padding:10px;margin-top:15px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:0.75rem}
.console-entry{padding:3px 0;color:#8892b0}
.console-entry.success{color:#22c55e}
.console-entry.error{color:#ef4444}
.console-entry.warning{color:#f59e0b}
.tabs{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap}
.tab{padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#8892b0;cursor:pointer}
.tab.active{background:#00d9ff;color:#000;border-color:#00d9ff}
.tab-content{display:none}
.tab-content.active{display:block}
.schedule-details{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;padding:15px;margin-bottom:15px}
.schedule-details h4{color:#22c55e;margin-bottom:10px}
.schedule-details table{width:100%;font-size:0.9rem}
.schedule-details td{padding:5px 0;color:#8892b0}
.schedule-details td:first-child{color:#fff;width:40%}
.history-item{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.history-result{padding:4px 10px;border-radius:12px;font-size:0.8rem}
.history-result.NO_TEST{background:rgba(34,197,94,0.2);color:#22c55e}
.history-result.MUST_TEST{background:rgba(239,68,68,0.2);color:#ef4444}
.history-result.UNKNOWN{background:rgba(245,158,11,0.2);color:#f59e0b}
.history-result.RETRY_PENDING{background:rgba(0,217,255,0.2);color:#00d9ff}
.info-box{background:rgba(0,217,255,0.1);border:1px solid rgba(0,217,255,0.3);border-radius:8px;padding:12px;margin-bottom:15px;font-size:0.85rem;color:#8892b0}
.info-box strong{color:#00d9ff}
.info-box.warning{background:rgba(245,158,11,0.1);border-color:rgba(245,158,11,0.3)}
.info-box.warning strong{color:#f59e0b}
small{color:#666;font-size:0.75rem}
.method-select{display:flex;gap:10px;margin-top:5px}
.method-option{flex:1;padding:12px;border-radius:8px;border:2px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);cursor:pointer;text-align:center;transition:all 0.2s}
.method-option:hover{border-color:rgba(255,255,255,0.3)}
.method-option.active{border-color:#00d9ff;background:rgba(0,217,255,0.1)}
.method-option .icon{font-size:1.5rem;margin-bottom:5px}
.method-option .label{font-size:0.85rem;color:#8892b0}
.method-option.active .label{color:#00d9ff}
.packages{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:15px}
.package{background:rgba(255,255,255,0.03);border:2px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
.package:hover{border-color:#00d9ff}
.package.popular{border-color:#00d9ff;background:rgba(0,217,255,0.05)}
.package-name{font-size:0.9rem;color:#8892b0;margin-bottom:5px}
.package-credits{font-size:2rem;font-weight:700;color:#fff}
.package-price{font-size:1.1rem;color:#00d9ff;margin-top:5px}
.package-save{font-size:0.75rem;color:#22c55e;margin-top:5px}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:100;padding:20px;overflow-y:auto}
.modal.active{display:flex}
.modal-content{background:#1a1a2e;border-radius:16px;padding:30px;max-width:500px;width:100%}
.modal-close{float:right;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
.promo-input{display:flex;gap:10px;margin-top:15px}
.promo-input input{flex:1}
.promo-input button{width:auto;padding:10px 20px}
.consent-box{background:rgba(0,217,255,0.1);border:2px solid rgba(0,217,255,0.3);border-radius:8px;padding:15px;margin:15px 0}
.consent-box h4{color:#00d9ff;margin-bottom:10px;font-size:0.95rem}
.consent-box p{color:#8892b0;font-size:0.8rem;margin-bottom:10px;line-height:1.5}
.consent-box label{display:flex;align-items:flex-start;gap:10px;cursor:pointer;color:#fff;font-size:0.85rem}
.consent-box input[type="checkbox"]{width:20px;height:20px;margin-top:2px;flex-shrink:0}
.consent-box a{color:#00d9ff}
.checkbox-group{display:flex;align-items:center;gap:10px;padding:12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:8px;margin:12px 0;cursor:pointer}
.checkbox-group input{width:18px;height:18px}
.checkbox-group label{color:#fff;font-size:0.9rem;cursor:pointer;flex:1}
.checkbox-group small{display:block;color:#8892b0;font-size:0.75rem;margin-top:3px}
.time-note{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:8px;padding:10px;margin:10px 0;font-size:0.8rem;color:#f59e0b}
/* Disclaimer Modal */
.disclaimer-modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);display:none;align-items:center;justify-content:center;z-index:200;padding:20px;overflow-y:auto}
.disclaimer-modal.active{display:flex}
.disclaimer-content{background:#1a1a2e;border-radius:16px;padding:30px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
.disclaimer-content h2{color:#ef4444;margin-bottom:20px;font-size:1.5rem}
.disclaimer-content h3{color:#f59e0b;margin:20px 0 10px;font-size:1.1rem}
.disclaimer-content p{color:#ccc;margin-bottom:15px;font-size:0.9rem;line-height:1.6}
.disclaimer-content ul{margin-left:20px;margin-bottom:15px;color:#ccc;font-size:0.9rem}
.disclaimer-content li{margin-bottom:8px}
.warning-banner{background:rgba(239,68,68,0.2);border:2px solid rgba(239,68,68,0.5);border-radius:12px;padding:20px;margin-bottom:20px}
.warning-banner p{color:#ef4444;font-weight:600;margin:0}
.agree-section{background:rgba(255,255,255,0.05);border-radius:12px;padding:20px;margin-top:25px}
.agree-section label{display:flex;align-items:flex-start;gap:12px;cursor:pointer;color:#fff;font-size:0.95rem;line-height:1.5;margin-bottom:15px}
.agree-section input[type="checkbox"]{width:24px;height:24px;flex-shrink:0;margin-top:2px}
.agree-btn{width:100%;padding:15px;border-radius:8px;border:none;background:#22c55e;color:#000;font-size:1.1rem;font-weight:700;cursor:pointer}
.agree-btn:disabled{background:#666;cursor:not-allowed}
.decline-btn{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);background:transparent;color:#8892b0;font-size:0.9rem;cursor:pointer;margin-top:10px}
.warning-strip{background:rgba(239,68,68,0.15);border:1px solid rgba(239,68,68,0.3);border-radius:8px;padding:10px 15px;margin-bottom:15px;font-size:0.8rem;color:#ef4444}
</style>
</head>
<body>

<!-- DISCLAIMER MODAL -->
<div class="disclaimer-modal" id="disclaimerModal">
<div class="disclaimer-content">
<h2>‚ö†Ô∏è Important Disclaimer</h2>

<div class="warning-banner">
<p>THIS SERVICE IS NOT A SUBSTITUTE FOR PERSONALLY CALLING YOUR PROBATION HOTLINE</p>
</div>

<p>Before using ProbationCall, you must understand and agree to the following:</p>

<h3>üö® Critical Warnings</h3>
<ul>
<li><strong>This is a convenience tool ONLY</strong> - not a guaranteed service</li>
<li><strong>Technology can fail</strong> - calls may not connect, speech recognition may be wrong</li>
<li><strong>YOU are responsible</strong> for your probation compliance, not us</li>
<li><strong>Always verify</strong> your testing status through official channels</li>
</ul>

<h3>‚öñÔ∏è What Could Go Wrong</h3>
<ul>
<li>The automated call might not connect</li>
<li>Speech recognition might misinterpret the message</li>
<li>You might receive an incorrect "No Test" notification when testing IS required</li>
<li>Notifications might be delayed or not delivered</li>
<li>Server outages could prevent scheduled calls</li>
</ul>

<h3>üõ°Ô∏è Your Responsibilities</h3>
<ul>
<li>Use this as a BACKUP, not your only method</li>
<li>Call the hotline yourself if anything seems wrong</li>
<li>Never blame this service for missed tests</li>
<li>Understand that YOU face the legal consequences, not us</li>
</ul>

<h3>üìã Legal Agreement</h3>
<p>By using this service, you agree that ProbationCall and its operators are <strong>NOT LIABLE</strong> for any consequences including but not limited to: arrest, incarceration, probation revocation, fines, or any other legal penalties resulting from service failures or inaccuracies.</p>

<div class="agree-section">
<label>
<input type="checkbox" id="agreeCheck1">
<span>I understand this service may fail or provide incorrect information, and I will NOT rely on it as my only method of checking my probation status.</span>
</label>

<label>
<input type="checkbox" id="agreeCheck2">
<span>I accept FULL RESPONSIBILITY for my probation compliance and will not hold ProbationCall liable for any consequences.</span>
</label>

<label>
<input type="checkbox" id="agreeCheck3">
<span>I have read and agree to the <a href="/terms.html" target="_blank" style="color:#00d9ff">Terms of Service</a> and <a href="/privacy.html" target="_blank" style="color:#00d9ff">Privacy Policy</a>.</span>
</label>

<button class="agree-btn" id="agreeBtn" disabled onclick="acceptTerms()">I Understand and Accept All Risks</button>
<button class="decline-btn" onclick="declineTerms()">I Do Not Agree - Exit</button>
</div>
</div>
</div>

<div class="loading" id="loading"><div class="spinner"></div><div style="color:#8892b0">Loading...</div></div>
<div class="container" id="app">
  <nav>
    <div class="logo">üìû ProbationCall</div>
    <div class="nav-right">
      <span class="dev-badge" id="devBadge" style="display:none">DEV</span>
      <span id="userEmail" style="color:#8892b0;font-size:0.85rem"></span>
      <button class="logout-btn" onclick="logout()">Sign Out</button>
    </div>
  </nav>
  
  <div class="warning-strip">
    ‚ö†Ô∏è <strong>Reminder:</strong> Always verify your status by calling the hotline yourself. This service is not guaranteed.
  </div>
  
  <div class="schedule-banner" id="scheduleBanner">
    <div><h3>‚úÖ Auto-Call Active</h3><p id="scheduleBannerText"></p></div>
    <div class="time" id="scheduleBannerTime"></div>
  </div>
  <div class="no-schedule" id="noSchedule">‚ö†Ô∏è No schedule set. Set up daily auto-calls in the Schedule tab.</div>
  
  <div class="credits-card">
    <div><div class="credits-num" id="credits">0</div><div class="credits-label">Credits</div></div>
    <button class="buy-btn" onclick="showBuyModal()">Buy Credits</button>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="showTab('call')">üìû Call</div>
    <div class="tab" onclick="showTab('schedule')">‚è∞ Schedule</div>
    <div class="tab" onclick="showTab('history')">üìú History</div>
    <div class="tab" onclick="showTab('test')">üß™ Test</div>
  </div>
  
  <div id="callTab" class="tab-content active">
    <div class="card">
      <h2>Make a Call</h2>
      <form id="callForm">
        <div class="form-group"><label>Hotline</label><input type="tel" id="targetNumber" value="+19362834848" required></div>
        <div class="form-group"><label>6-Digit PIN</label><input type="text" id="pin" maxlength="6" placeholder="123456" required></div>
        <div class="form-group">
          <label>How should we notify you?</label>
          <div class="method-select">
            <div class="method-option active" onclick="selectMethod('email')"><div class="icon">üìß</div><div class="label">Email</div></div>
            <div class="method-option" onclick="selectMethod('sms')"><div class="icon">üí¨</div><div class="label">SMS</div></div>
            <div class="method-option" onclick="selectMethod('whatsapp')"><div class="icon">üì±</div><div class="label">WhatsApp</div></div>
          </div>
          <input type="hidden" id="notifyMethod" value="email">
        </div>
        <div class="form-group" id="emailGroup"><label>Your Email</label><input type="email" id="notifyEmail" placeholder="you@example.com"></div>
        <div class="form-group" id="phoneGroup" style="display:none"><label>Your Phone Number</label><input type="tel" id="notifyNumber" placeholder="+1234567890"></div>
        
        <div class="checkbox-group" onclick="document.getElementById('retryOnUnknown').click()">
          <input type="checkbox" id="retryOnUnknown">
          <label for="retryOnUnknown">Auto-retry on unknown result<small>If we can't determine the result, automatically try again in 5 minutes (max 2 retries)</small></label>
        </div>
        
        <div class="consent-box" id="smsConsentBox" style="display:none">
          <h4>üì± SMS Notification Consent</h4>
          <p>By checking the box below, you agree to receive SMS text messages from ProbationCall. Message frequency: up to 1 per call. Msg & data rates may apply. Reply STOP to unsubscribe.</p>
          <label><input type="checkbox" id="smsConsent"><span>I agree to receive SMS messages and have read the <a href="/terms.html" target="_blank">Terms</a> and <a href="/privacy.html" target="_blank">Privacy Policy</a>.</span></label>
        </div>
        
        <button type="submit" class="btn" id="callBtn">üìû Call Now</button>
      </form>
      <div id="callStatus" class="status" style="display:none"></div>
      <div class="console" id="console"></div>
    </div>
  </div>
  
  <div id="scheduleTab" class="tab-content">
    <div class="card">
      <h2>Daily Schedule</h2>
      <div class="schedule-details" id="scheduleDetails" style="display:none">
        <h4>‚úÖ Schedule Active</h4>
        <table>
          <tr><td>Time:</td><td id="schedDisplayTime"></td></tr>
          <tr><td>Timezone:</td><td id="schedDisplayTZ"></td></tr>
          <tr><td>Hotline:</td><td id="schedDisplayTarget"></td></tr>
          <tr><td>PIN:</td><td id="schedDisplayPin"></td></tr>
          <tr><td>Notify:</td><td id="schedDisplayNotify"></td></tr>
          <tr><td>Method:</td><td id="schedDisplayMethod"></td></tr>
          <tr><td>Auto-Retry:</td><td id="schedDisplayRetry"></td></tr>
        </table>
        <button class="btn btn-danger" style="margin-top:15px" onclick="deleteSchedule()">üóëÔ∏è Delete</button>
      </div>
      <div class="info-box" id="noSchedInfo"><strong>No schedule.</strong> Set up auto-calls below.</div>
      <form id="scheduleForm">
        <div class="form-group"><label>Hotline</label><input type="tel" id="schedTarget" value="+19362834848" required></div>
        <div class="form-group"><label>6-Digit PIN</label><input type="text" id="schedPin" maxlength="6" placeholder="123456" required></div>
        <div class="form-group">
          <label>Notification Method</label>
          <div class="method-select">
            <div class="method-option active" onclick="selectSchedMethod('email')"><div class="icon">üìß</div><div class="label">Email</div></div>
            <div class="method-option" onclick="selectSchedMethod('sms')"><div class="icon">üí¨</div><div class="label">SMS</div></div>
            <div class="method-option" onclick="selectSchedMethod('whatsapp')"><div class="icon">üì±</div><div class="label">WhatsApp</div></div>
          </div>
          <input type="hidden" id="schedMethod" value="email">
        </div>
        <div class="form-group" id="schedEmailGroup"><label>Your Email</label><input type="email" id="schedEmail" placeholder="you@example.com"></div>
        <div class="form-group" id="schedPhoneGroup" style="display:none"><label>Your Phone</label><input type="tel" id="schedNotify" placeholder="+1234567890"></div>
        
        <div class="consent-box" id="schedSmsConsentBox" style="display:none">
          <h4>üì± SMS Notification Consent</h4>
          <p>By checking the box below, you agree to receive daily SMS messages from ProbationCall. Msg & data rates may apply. Reply STOP to unsubscribe.</p>
          <label><input type="checkbox" id="schedSmsConsent"><span>I agree to receive SMS messages and have read the <a href="/terms.html" target="_blank">Terms</a> and <a href="/privacy.html" target="_blank">Privacy Policy</a>.</span></label>
        </div>
        
        <div class="form-group">
          <label>Time</label>
          <div class="time-note">‚è∞ Calls can only be scheduled between <strong>6:00 AM</strong> and <strong>2:59 PM</strong></div>
          <div style="display:flex;gap:10px;margin-top:10px">
            <select id="schedHour" style="width:100px">
              <option value="6">6 AM</option>
              <option value="7">7 AM</option>
              <option value="8">8 AM</option>
              <option value="9">9 AM</option>
              <option value="10">10 AM</option>
              <option value="11">11 AM</option>
              <option value="12">12 PM</option>
              <option value="13">1 PM</option>
              <option value="14">2 PM</option>
            </select>
            <span style="padding:10px">:</span>
            <input type="number" id="schedMin" min="0" max="59" value="0" style="width:70px">
            <select id="schedTZ"><option value="America/Chicago">Central</option><option value="America/New_York">Eastern</option><option value="America/Denver">Mountain</option><option value="America/Los_Angeles">Pacific</option></select>
          </div>
        </div>
        
        <div class="checkbox-group" onclick="document.getElementById('schedRetry').click()">
          <input type="checkbox" id="schedRetry">
          <label for="schedRetry">Auto-retry on unknown result<small>If we can't determine the result, automatically try again in 5 minutes (max 2 retries)</small></label>
        </div>
        
        <button type="submit" class="btn" id="schedBtn">üíæ Save Schedule</button>
      </form>
    </div>
  </div>
  
  <div id="historyTab" class="tab-content">
    <div class="card"><h2>Call History</h2><div id="historyList"></div></div>
  </div>
  
  <div id="testTab" class="tab-content">
    <div class="card">
      <h2>üß™ Test Notifications</h2>
      <div class="info-box"><strong>Email</strong> is the most reliable method.</div>
      <h3 style="margin:20px 0 10px;font-size:1rem">Test Email</h3>
      <div class="form-group"><input type="email" id="testEmail" placeholder="you@example.com"></div>
      <button class="btn" onclick="testEmail()">üìß Send Test Email</button>
      <h3 style="margin:20px 0 10px;font-size:1rem">Test SMS</h3>
      <div class="form-group"><input type="tel" id="testPhone" placeholder="+1234567890"></div>
      <button class="btn btn-secondary" onclick="testSMS()">üí¨ Send Test SMS</button>
      <h3 style="margin:20px 0 10px;font-size:1rem">Test WhatsApp</h3>
      <div class="info-box warning"><strong>First:</strong> Message <strong>+1 555 896 5863</strong> from WhatsApp, then test.</div>
      <button class="btn btn-secondary" onclick="testWhatsApp()">üì± Send Test WhatsApp</button>
      <div id="testStatus" class="status" style="display:none;margin-top:15px"></div>
    </div>
  </div>
</div>

<div class="modal" id="buyModal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeBuyModal()">&times;</button>
    <h2 style="margin-bottom:10px">Buy Credits</h2>
    <p style="color:#8892b0;margin-bottom:5px">1 credit = 1 automated call</p>
    <div class="packages">
      <div class="package" onclick="buyPackage('starter')"><div class="package-name">Starter</div><div class="package-credits">30</div><div class="package-price">$9.99</div></div>
      <div class="package popular" onclick="buyPackage('standard')"><div class="package-name">Standard</div><div class="package-credits">90</div><div class="package-price">$24.99</div><div class="package-save">Save 17%</div></div>
      <div class="package" onclick="buyPackage('value')"><div class="package-name">Value</div><div class="package-credits">180</div><div class="package-price">$39.99</div><div class="package-save">Save 33%</div></div>
    </div>
    <div class="promo-input"><input type="text" id="promoCode" placeholder="Promo code"><button class="btn" onclick="redeemPromo()">Apply</button></div>
    <div id="promoStatus" class="status" style="display:none;margin-top:10px"></div>
  </div>
</div>

<script>
var SUPA_URL = 'https://xvpuqeaowvlkcyywgaaq.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cHVxZWFvd3Zsa2N5eXdnYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzc1MjcsImV4cCI6MjA3OTg1MzUyN30.y90odNDSU0zZcVGMK9C39gSFDL9NJcy5E4yBkgcFc8w';
var supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);
var token = null;
var termsAccepted = false;

// Checkbox listeners for disclaimer
document.querySelectorAll('#agreeCheck1, #agreeCheck2, #agreeCheck3').forEach(function(cb) {
  cb.addEventListener('change', function() {
    var allChecked = document.getElementById('agreeCheck1').checked && 
                     document.getElementById('agreeCheck2').checked && 
                     document.getElementById('agreeCheck3').checked;
    document.getElementById('agreeBtn').disabled = !allChecked;
  });
});

function acceptTerms() {
  document.getElementById('agreeBtn').disabled = true;
  document.getElementById('agreeBtn').textContent = 'Saving...';
  
  fetch('/api/accept-terms', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token }
  }).then(function(r) { return r.json(); }).then(function(d) {
    if (d.success) {
      termsAccepted = true;
      document.getElementById('disclaimerModal').classList.remove('active');
    } else {
      alert('Failed to save. Please try again.');
      document.getElementById('agreeBtn').disabled = false;
      document.getElementById('agreeBtn').textContent = 'I Understand and Accept All Risks';
    }
  }).catch(function() {
    alert('Failed to save. Please try again.');
    document.getElementById('agreeBtn').disabled = false;
    document.getElementById('agreeBtn').textContent = 'I Understand and Accept All Risks';
  });
}

function declineTerms() {
  window.location.href = '/';
}

function showDisclaimerIfNeeded() {
  if (!termsAccepted) {
    document.getElementById('disclaimerModal').classList.add('active');
  }
}

async function init() {
  if (window.location.hash.includes('access_token')) {
    await new Promise(function(r) { setTimeout(r, 1500); });
  }
  var result = await supabase.auth.getSession();
  if (result.data.session) {
    token = result.data.session.access_token;
    showDashboard();
  } else {
    window.location.href = '/login';
  }
}

supabase.auth.onAuthStateChange(function(event, session) {
  if (event === 'SIGNED_IN' && session) {
    token = session.access_token;
    showDashboard();
  }
});

function showDashboard() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  loadUser();
  connectWS();
  
  var params = new URLSearchParams(window.location.search);
  if (params.get('success')) {
    alert('‚úÖ Payment successful! Credits added.');
    history.replaceState({}, '', '/dashboard');
  }
}

function formatTime(h, m) {
  var hr = h % 12 || 12;
  var ampm = h >= 12 ? 'PM' : 'AM';
  return hr + ':' + String(m).padStart(2, '0') + ' ' + ampm;
}

function selectMethod(method) {
  document.querySelectorAll('#callTab .method-option').forEach(function(el) { el.classList.remove('active'); });
  event.target.closest('.method-option').classList.add('active');
  document.getElementById('notifyMethod').value = method;
  document.getElementById('emailGroup').style.display = method === 'email' ? 'block' : 'none';
  document.getElementById('phoneGroup').style.display = method !== 'email' ? 'block' : 'none';
  document.getElementById('smsConsentBox').style.display = method === 'sms' ? 'block' : 'none';
}

function selectSchedMethod(method) {
  document.querySelectorAll('#scheduleTab .method-option').forEach(function(el) { el.classList.remove('active'); });
  event.target.closest('.method-option').classList.add('active');
  document.getElementById('schedMethod').value = method;
  document.getElementById('schedEmailGroup').style.display = method === 'email' ? 'block' : 'none';
  document.getElementById('schedPhoneGroup').style.display = method !== 'email' ? 'block' : 'none';
  document.getElementById('schedSmsConsentBox').style.display = method === 'sms' ? 'block' : 'none';
}

function loadUser() {
  fetch('/api/user', { headers: { Authorization: 'Bearer ' + token } })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      // Check if terms accepted
      termsAccepted = d.termsAccepted;
      showDisclaimerIfNeeded();
      
      document.getElementById('userEmail').textContent = d.user.email;
      document.getElementById('credits').textContent = d.isDev ? '‚àû' : d.profile.credits;
      if (d.isDev) document.getElementById('devBadge').style.display = 'inline';
      
      document.getElementById('notifyEmail').value = d.user.email;
      document.getElementById('schedEmail').value = d.user.email;
      document.getElementById('testEmail').value = d.user.email;
      
      if (d.schedule) {
        var t = formatTime(d.schedule.hour, d.schedule.minute);
        document.getElementById('scheduleBannerText').textContent = 'Daily at ' + t + (d.schedule.retry_on_unknown ? ' (auto-retry on)' : '');
        document.getElementById('scheduleBannerTime').textContent = t;
        document.getElementById('scheduleBanner').classList.add('active');
        document.getElementById('noSchedule').classList.remove('active');
        
        document.getElementById('schedDisplayTime').textContent = t;
        document.getElementById('schedDisplayTZ').textContent = d.schedule.timezone;
        document.getElementById('schedDisplayTarget').textContent = d.schedule.target_number;
        document.getElementById('schedDisplayPin').textContent = d.schedule.pin;
        document.getElementById('schedDisplayNotify').textContent = d.schedule.notify_email || d.schedule.notify_number || '-';
        document.getElementById('schedDisplayMethod').textContent = (d.schedule.notify_method || 'email').toUpperCase();
        document.getElementById('schedDisplayRetry').textContent = d.schedule.retry_on_unknown ? 'Yes (5 min delay)' : 'No';
        document.getElementById('scheduleDetails').style.display = 'block';
        document.getElementById('noSchedInfo').style.display = 'none';
        document.getElementById('schedBtn').textContent = 'üíæ Update Schedule';
        
        document.getElementById('schedTarget').value = d.schedule.target_number;
        document.getElementById('schedPin').value = d.schedule.pin;
        document.getElementById('schedHour').value = d.schedule.hour;
        document.getElementById('schedMin').value = d.schedule.minute;
        document.getElementById('schedTZ').value = d.schedule.timezone;
        document.getElementById('schedRetry').checked = d.schedule.retry_on_unknown || false;
        if (d.schedule.notify_email) document.getElementById('schedEmail').value = d.schedule.notify_email;
        if (d.schedule.notify_number) document.getElementById('schedNotify').value = d.schedule.notify_number;
      } else {
        document.getElementById('scheduleBanner').classList.remove('active');
        document.getElementById('noSchedule').classList.add('active');
        document.getElementById('scheduleDetails').style.display = 'none';
        document.getElementById('noSchedInfo').style.display = 'block';
      }
      
      var el = document.getElementById('historyList');
      if (!d.history || !d.history.length) {
        el.innerHTML = '<p style="color:#666">No calls yet</p>';
      } else {
        el.innerHTML = d.history.map(function(h) {
          var txt = h.result === 'NO_TEST' ? '‚úÖ No Test' : h.result === 'MUST_TEST' ? 'üö® Must Test' : h.result === 'RETRY_PENDING' ? 'üîÑ Retrying...' : '‚ö†Ô∏è Unknown';
          return '<div class="history-item"><div>' + new Date(h.created_at).toLocaleString() + '<br><small>PIN: ' + h.pin_used + '</small></div><span class="history-result ' + h.result + '">' + txt + '</span></div>';
        }).join('');
      }
    });
}

function showTab(name) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
  event.target.classList.add('active');
  document.getElementById(name + 'Tab').classList.add('active');
}

function showBuyModal() { document.getElementById('buyModal').classList.add('active'); }
function closeBuyModal() { document.getElementById('buyModal').classList.remove('active'); }

function buyPackage(packageId) {
  fetch('/api/checkout', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({ packageId: packageId })
  }).then(function(r) { return r.json(); }).then(function(d) {
    if (d.url) window.location.href = d.url;
    else alert('Error: ' + (d.error || 'Unknown'));
  });
}

function redeemPromo() {
  var code = document.getElementById('promoCode').value;
  var st = document.getElementById('promoStatus');
  if (!code) return;
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'Applying...';
  fetch('/api/redeem', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({ code: code })
  }).then(function(r) { return r.json(); }).then(function(d) {
    if (d.success) {
      st.className = 'status success';
      st.textContent = '‚úÖ Added ' + d.credits + ' credits!';
      loadUser();
      setTimeout(closeBuyModal, 1500);
    } else {
      st.className = 'status error';
      st.textContent = '‚ùå ' + (d.error || 'Invalid code');
    }
  });
}

var ws;
function connectWS() {
  ws = new WebSocket((location.protocol === 'https:' ? 'wss:' : 'ws:') + '//' + location.host + '/ws');
  ws.onmessage = function(e) {
    var d = JSON.parse(e.data);
    if (d.type === 'log') addLog(d.log.message, d.log.type);
    if (d.type === 'result') {
      var st = document.getElementById('callStatus');
      st.style.display = 'block';
      if (d.result === 'NO_TEST') { st.className = 'status success'; st.textContent = '‚úÖ No test today!'; }
      else if (d.result === 'MUST_TEST') { st.className = 'status error'; st.textContent = 'üö® TEST REQUIRED!'; }
      else if (d.result === 'RETRY_PENDING') { st.className = 'status retry'; st.textContent = 'üîÑ Retrying in 5 min...'; }
      else { st.className = 'status warning'; st.textContent = '‚ö†Ô∏è Unknown result'; }
      loadUser();
    }
  };
  ws.onclose = function() { setTimeout(connectWS, 5000); };
  ws.onerror = function() {};
}

function addLog(msg, type) {
  var c = document.getElementById('console');
  c.innerHTML += '<div class="console-entry ' + (type || '') + '">' + new Date().toLocaleTimeString() + ' - ' + msg + '</div>';
  c.scrollTop = c.scrollHeight;
}

document.getElementById('callForm').onsubmit = function(e) {
  e.preventDefault();
  var method = document.getElementById('notifyMethod').value;
  if (method === 'sms' && !document.getElementById('smsConsent').checked) {
    alert('Please agree to receive SMS messages.');
    return;
  }
  var btn = document.getElementById('callBtn');
  var st = document.getElementById('callStatus');
  btn.disabled = true;
  btn.textContent = 'Calling...';
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'Calling...';
  document.getElementById('console').innerHTML = '';
  fetch('/api/call', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({
      targetNumber: document.getElementById('targetNumber').value,
      pin: document.getElementById('pin').value,
      notifyNumber: document.getElementById('notifyNumber').value,
      notifyEmail: document.getElementById('notifyEmail').value,
      notifyMethod: method,
      retryOnUnknown: document.getElementById('retryOnUnknown').checked
    })
  }).then(function(r) { return r.json(); }).then(function(d) {
    if (d.error) { st.className = 'status error'; st.textContent = d.error; }
    btn.disabled = false;
    btn.textContent = 'üìû Call Now';
  });
};

document.getElementById('scheduleForm').onsubmit = function(e) {
  e.preventDefault();
  var method = document.getElementById('schedMethod').value;
  if (method === 'sms' && !document.getElementById('schedSmsConsent').checked) {
    alert('Please agree to receive SMS messages.');
    return;
  }
  var hour = parseInt(document.getElementById('schedHour').value);
  var minute = parseInt(document.getElementById('schedMin').value);
  if (hour < 6 || hour > 14) {
    alert('Schedule time must be between 6:00 AM and 2:59 PM');
    return;
  }
  var btn = document.getElementById('schedBtn');
  btn.disabled = true;
  fetch('/api/schedule', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({
      targetNumber: document.getElementById('schedTarget').value,
      pin: document.getElementById('schedPin').value,
      notifyNumber: document.getElementById('schedNotify').value,
      notifyEmail: document.getElementById('schedEmail').value,
      notifyMethod: method,
      hour: hour,
      minute: minute,
      timezone: document.getElementById('schedTZ').value,
      retryOnUnknown: document.getElementById('schedRetry').checked
    })
  }).then(function(r) { return r.json(); }).then(function(d) {
    btn.disabled = false;
    if (d.success) { alert('‚úÖ Schedule saved!'); loadUser(); }
    else { alert('Error: ' + (d.error || 'Unknown')); }
  });
};

function deleteSchedule() {
  if (!confirm('Delete schedule?')) return;
  fetch('/api/schedule', { method: 'DELETE', headers: { Authorization: 'Bearer ' + token } })
    .then(function() { alert('Deleted'); loadUser(); });
}

function testEmail() {
  var st = document.getElementById('testStatus');
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'Sending...';
  fetch('/api/test-email', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({ email: document.getElementById('testEmail').value })
  }).then(function(r) { return r.json(); }).then(function(d) {
    st.className = 'status ' + (d.success ? 'success' : 'error');
    st.textContent = d.success ? '‚úÖ Email sent!' : '‚ùå ' + (d.error || 'Failed');
  });
}

function testSMS() {
  var st = document.getElementById('testStatus');
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'Sending...';
  fetch('/api/test-sms', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({ notifyNumber: document.getElementById('testPhone').value })
  }).then(function(r) { return r.json(); }).then(function(d) {
    st.className = 'status ' + (d.success ? 'success' : 'error');
    st.textContent = d.success ? '‚úÖ SMS sent!' : '‚ùå ' + (d.error || 'Failed');
  });
}

function testWhatsApp() {
  var phone = document.getElementById('testPhone').value;
  if (!phone) { alert('Enter phone number first'); return; }
  var st = document.getElementById('testStatus');
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'Sending...';
  fetch('/api/test-whatsapp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + token },
    body: JSON.stringify({ notifyNumber: phone })
  }).then(function(r) { return r.json(); }).then(function(d) {
    st.className = 'status ' + (d.success ? 'success' : 'error');
    st.textContent = d.success ? '‚úÖ WhatsApp sent!' : '‚ùå ' + (d.error || 'Failed');
  });
}

function logout() {
  supabase.auth.signOut().then(function() { window.location.href = '/'; });
}

init();
</script>
</body>
</html>
