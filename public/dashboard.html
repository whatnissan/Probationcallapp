<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard - ProbationCall</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#0a0a0f;color:#fff;min-height:100vh}
.loading{display:flex;align-items:center;justify-content:center;height:100vh;font-size:1.2rem;color:#8892b0}
.container{max-width:800px;margin:0 auto;padding:20px;display:none}
nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1)}
.logo{font-size:1.2rem;font-weight:700;color:#00d9ff}
.nav-right{display:flex;align-items:center;gap:10px}
.dev-badge{background:#f59e0b;color:#000;padding:4px 8px;border-radius:4px;font-size:0.7rem;font-weight:700}
.logout-btn{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer;font-size:0.85rem}
.credits-card{background:linear-gradient(135deg,#00d9ff,#0099cc);border-radius:12px;padding:20px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
.credits-num{font-size:2.2rem;font-weight:700;color:#000}
.credits-label{color:rgba(0,0,0,0.6);font-size:0.85rem}
.schedule-banner{background:linear-gradient(135deg,#22c55e,#16a34a);border-radius:12px;padding:15px 20px;margin-bottom:20px;display:none}
.schedule-banner.active{display:flex;justify-content:space-between;align-items:center}
.schedule-banner h3{color:#000;font-size:1rem;margin-bottom:3px}
.schedule-banner p{color:rgba(0,0,0,0.7);font-size:0.85rem}
.schedule-banner .time{font-size:1.5rem;font-weight:700;color:#000}
.no-schedule-banner{background:rgba(245,158,11,0.2);border:1px solid rgba(245,158,11,0.4);border-radius:12px;padding:15px 20px;margin-bottom:20px;display:none}
.no-schedule-banner.active{display:block}
.no-schedule-banner p{color:#f59e0b;font-size:0.9rem}
.card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;margin-bottom:15px}
.card h2{color:#00d9ff;margin-bottom:15px;font-size:1.1rem}
.form-group{margin-bottom:12px}
label{display:block;margin-bottom:5px;color:#8892b0;font-size:0.85rem}
input,select{width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff;font-size:1rem}
input:focus,select:focus{outline:none;border-color:#00d9ff}
.btn{width:100%;padding:12px;border-radius:8px;border:none;background:linear-gradient(135deg,#00d9ff,#0099cc);color:#000;font-size:1rem;font-weight:600;cursor:pointer;margin-top:8px}
.btn:hover{opacity:0.9}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
.btn-danger{background:rgba(239,68,68,0.8);color:#fff}
.btn-row{display:flex;gap:10px;margin-top:10px}
.btn-row .btn{flex:1}
.status{padding:12px;border-radius:8px;margin-top:12px;text-align:center;font-weight:500}
.status.success{background:rgba(34,197,94,0.2);color:#22c55e}
.status.error{background:rgba(239,68,68,0.2);color:#ef4444}
.status.calling{background:rgba(0,217,255,0.2);color:#00d9ff}
.status.warning{background:rgba(245,158,11,0.2);color:#f59e0b}
.console{background:#000;border:1px solid #333;border-radius:8px;padding:10px;margin-top:15px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:0.75rem}
.console-entry{padding:3px 0;border-bottom:1px solid #1a1a1a}
.console-entry.info{color:#8892b0}
.console-entry.success{color:#22c55e}
.console-entry.error{color:#ef4444}
.console-entry.warning{color:#f59e0b}
.console-time{color:#555;margin-right:8px}
.tabs{display:flex;gap:8px;margin-bottom:15px}
.tab{padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#8892b0;cursor:pointer;font-size:0.9rem}
.tab.active{background:#00d9ff;color:#000;border-color:#00d9ff}
.tab-content{display:none}
.tab-content.active{display:block}
.schedule-details{background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.3);border-radius:8px;padding:15px;margin-bottom:15px}
.schedule-details h4{color:#22c55e;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.schedule-details table{width:100%;font-size:0.9rem}
.schedule-details td{padding:5px 0;color:#8892b0}
.schedule-details td:first-child{color:#fff;width:40%}
.history-item{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.history-result{padding:4px 10px;border-radius:12px;font-size:0.8rem;font-weight:500}
.history-result.NO_TEST{background:rgba(34,197,94,0.2);color:#22c55e}
.history-result.MUST_TEST{background:rgba(239,68,68,0.2);color:#ef4444}
.history-result.UNKNOWN{background:rgba(245,158,11,0.2);color:#f59e0b}
.radio-group{display:flex;gap:15px;margin-top:5px}
.radio-group label{display:flex;align-items:center;gap:6px;cursor:pointer;color:#fff}
.radio-group input{width:auto}
small{color:#666;font-size:0.75rem}
.info-box{background:rgba(0,217,255,0.1);border:1px solid rgba(0,217,255,0.3);border-radius:8px;padding:12px;margin-bottom:15px;font-size:0.85rem;color:#8892b0}
.info-box strong{color:#00d9ff}
</style>
</head>
<body>
<div class="loading" id="loading">Loading...</div>
<div class="container" id="app">
  <nav>
    <div class="logo">üìû ProbationCall</div>
    <div class="nav-right">
      <span class="dev-badge" id="devBadge" style="display:none">DEV MODE</span>
      <span id="userEmail" style="color:#8892b0;font-size:0.85rem"></span>
      <button class="logout-btn" onclick="logout()">Sign Out</button>
    </div>
  </nav>
  
  <!-- Schedule Status Banner -->
  <div class="schedule-banner" id="scheduleBanner">
    <div>
      <h3>‚úÖ Auto-Call Active</h3>
      <p id="scheduleBannerText">Daily at 6:00 AM Central</p>
    </div>
    <div class="time" id="scheduleBannerTime">6:00 AM</div>
  </div>
  
  <div class="no-schedule-banner" id="noScheduleBanner">
    <p>‚ö†Ô∏è No schedule set. Go to Schedule tab to set up automatic daily calls.</p>
  </div>
  
  <div class="credits-card">
    <div>
      <div class="credits-num" id="credits">0</div>
      <div class="credits-label">Credits</div>
    </div>
  </div>
  
  <div class="tabs">
    <div class="tab active" onclick="showTab('call')">üìû Call Now</div>
    <div class="tab" onclick="showTab('schedule')">‚è∞ Schedule</div>
    <div class="tab" onclick="showTab('history')">üìú History</div>
    <div class="tab" onclick="showTab('test')">üß™ Test</div>
  </div>
  
  <!-- CALL TAB -->
  <div id="callTab" class="tab-content active">
    <div class="card">
      <h2>Make a Call</h2>
      <form id="callForm">
        <div class="form-group">
          <label>Hotline Number</label>
          <input type="tel" id="targetNumber" value="+19362834848" required>
        </div>
        <div class="form-group">
          <label>Your 6-Digit PIN</label>
          <input type="text" id="pin" maxlength="6" placeholder="123456" required>
        </div>
        <div class="form-group">
          <label>Your Phone Number (for notifications)</label>
          <input type="tel" id="notifyNumber" placeholder="+1234567890" required>
        </div>
        <div class="form-group">
          <label>Notification Method</label>
          <div class="radio-group">
            <label><input type="radio" name="notifyMethod" value="whatsapp" checked> WhatsApp</label>
            <label><input type="radio" name="notifyMethod" value="sms"> SMS</label>
          </div>
        </div>
        <button type="submit" class="btn" id="callBtn">üìû Call Now</button>
      </form>
      <div id="callStatus" class="status" style="display:none"></div>
      <div class="console" id="console"></div>
    </div>
  </div>
  
  <!-- SCHEDULE TAB -->
  <div id="scheduleTab" class="tab-content">
    <div class="card">
      <h2>‚è∞ Daily Auto-Call Schedule</h2>
      
      <!-- Current Schedule Display -->
      <div class="schedule-details" id="scheduleDetails" style="display:none">
        <h4>‚úÖ Schedule Active</h4>
        <table>
          <tr><td>Time:</td><td id="schedDisplayTime">-</td></tr>
          <tr><td>Timezone:</td><td id="schedDisplayTZ">-</td></tr>
          <tr><td>Hotline:</td><td id="schedDisplayTarget">-</td></tr>
          <tr><td>PIN:</td><td id="schedDisplayPin">-</td></tr>
          <tr><td>Notify:</td><td id="schedDisplayNotify">-</td></tr>
          <tr><td>Method:</td><td id="schedDisplayMethod">-</td></tr>
        </table>
        <button class="btn btn-danger" style="margin-top:15px" onclick="deleteSchedule()">üóëÔ∏è Delete Schedule</button>
      </div>
      
      <div class="info-box" id="noScheduleInfo">
        <strong>No schedule set.</strong> Fill out the form below to automatically call the hotline every day at your chosen time.
      </div>
      
      <form id="scheduleForm">
        <div class="form-group">
          <label>Hotline Number</label>
          <input type="tel" id="schedTarget" value="+19362834848" required>
        </div>
        <div class="form-group">
          <label>Your 6-Digit PIN</label>
          <input type="text" id="schedPin" maxlength="6" placeholder="123456" required>
        </div>
        <div class="form-group">
          <label>Your Phone Number</label>
          <input type="tel" id="schedNotify" placeholder="+1234567890" required>
        </div>
        <div class="form-group">
          <label>Notification Method</label>
          <div class="radio-group">
            <label><input type="radio" name="schedMethod" value="whatsapp" checked> WhatsApp</label>
            <label><input type="radio" name="schedMethod" value="sms"> SMS</label>
          </div>
        </div>
        <div class="form-group">
          <label>Call Time (24-hour format)</label>
          <div style="display:flex;gap:10px">
            <input type="number" id="schedHour" min="0" max="23" value="6" style="width:80px" required>
            <span style="color:#fff;padding:10px 0">:</span>
            <input type="number" id="schedMin" min="0" max="59" value="0" style="width:80px" required>
            <select id="schedTZ">
              <option value="America/Chicago">Central</option>
              <option value="America/New_York">Eastern</option>
              <option value="America/Denver">Mountain</option>
              <option value="America/Los_Angeles">Pacific</option>
            </select>
          </div>
          <small>Examples: 6:00 = 6 AM, 18:00 = 6 PM</small>
        </div>
        <button type="submit" class="btn" id="saveSchedBtn">üíæ Save Schedule</button>
      </form>
    </div>
  </div>
  
  <!-- HISTORY TAB -->
  <div id="historyTab" class="tab-content">
    <div class="card">
      <h2>üìú Call History</h2>
      <div id="historyList"></div>
    </div>
  </div>
  
  <!-- TEST TAB -->
  <div id="testTab" class="tab-content">
    <div class="card">
      <h2>üß™ Test Notifications</h2>
      <div class="info-box">
        <strong>WhatsApp Users:</strong> You must first send a message to <strong>+1 555 896 5863</strong> from your WhatsApp before you can receive notifications.
      </div>
      <div class="form-group">
        <label>Phone Number to Test</label>
        <input type="tel" id="testNumber" placeholder="+1234567890">
      </div>
      <div class="btn-row">
        <button class="btn" onclick="testWhatsApp()">üì± Test WhatsApp</button>
        <button class="btn btn-secondary" onclick="testSMS()">üí¨ Test SMS</button>
      </div>
      <div id="testStatus" class="status" style="display:none"></div>
    </div>
  </div>
</div>

<script>
var SUPA_URL = 'https://xvpuqeaowvlkcyywgaaq.supabase.co';
var SUPA_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cHVxZWFvd3Zsa2N5eXdnYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzc1MjcsImV4cCI6MjA3OTg1MzUyN30.y90odNDSU0zZcVGMK9C39gSFDL9NJcy5E4yBkgcFc8w';
var supabase = window.supabase.createClient(SUPA_URL, SUPA_KEY);
var token = null;
var isDev = false;
var currentSchedule = null;

async function init() {
  var hash = window.location.hash;
  if (hash && hash.includes('access_token')) {
    history.replaceState(null, '', window.location.pathname);
    await new Promise(function(r) { setTimeout(r, 1000); });
  }
  
  var result = await supabase.auth.getSession();
  if (result.data.session) {
    token = result.data.session.access_token;
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadUser();
    connectWebSocket();
  } else {
    window.location.href = '/login';
  }
}

supabase.auth.onAuthStateChange(function(event, session) {
  if (event === 'SIGNED_IN' && session) {
    token = session.access_token;
    document.getElementById('loading').style.display = 'none';
    document.getElementById('app').style.display = 'block';
    loadUser();
    connectWebSocket();
  }
});

init();

function formatTime(hour, minute) {
  var h = hour % 12 || 12;
  var ampm = hour >= 12 ? 'PM' : 'AM';
  var m = String(minute).padStart(2, '0');
  return h + ':' + m + ' ' + ampm;
}

function formatTimezone(tz) {
  var names = {
    'America/Chicago': 'Central',
    'America/New_York': 'Eastern',
    'America/Denver': 'Mountain',
    'America/Los_Angeles': 'Pacific'
  };
  return names[tz] || tz;
}

function loadUser() {
  fetch('/api/user', { headers: { 'Authorization': 'Bearer ' + token } })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      document.getElementById('userEmail').textContent = d.user.email;
      document.getElementById('credits').textContent = d.profile.credits;
      
      if (d.isDev) {
        isDev = true;
        document.getElementById('devBadge').style.display = 'inline-block';
        document.getElementById('credits').textContent = '‚àû';
      }
      
      // Handle schedule display
      if (d.schedule) {
        currentSchedule = d.schedule;
        
        // Fill form with current values
        document.getElementById('schedTarget').value = d.schedule.target_number || '';
        document.getElementById('schedPin').value = d.schedule.pin || '';
        document.getElementById('schedNotify').value = d.schedule.notify_number || '';
        document.getElementById('schedHour').value = d.schedule.hour || 6;
        document.getElementById('schedMin').value = d.schedule.minute || 0;
        document.getElementById('schedTZ').value = d.schedule.timezone || 'America/Chicago';
        
        if (d.schedule.notify_method === 'sms') {
          document.querySelector('input[name="schedMethod"][value="sms"]').checked = true;
        }
        
        // Show schedule banner
        var timeStr = formatTime(d.schedule.hour, d.schedule.minute);
        var tzStr = formatTimezone(d.schedule.timezone);
        document.getElementById('scheduleBannerText').textContent = 'Daily at ' + timeStr + ' ' + tzStr;
        document.getElementById('scheduleBannerTime').textContent = timeStr;
        document.getElementById('scheduleBanner').classList.add('active');
        document.getElementById('noScheduleBanner').classList.remove('active');
        
        // Show schedule details in schedule tab
        document.getElementById('schedDisplayTime').textContent = timeStr;
        document.getElementById('schedDisplayTZ').textContent = tzStr;
        document.getElementById('schedDisplayTarget').textContent = d.schedule.target_number;
        document.getElementById('schedDisplayPin').textContent = d.schedule.pin;
        document.getElementById('schedDisplayNotify').textContent = d.schedule.notify_number;
        document.getElementById('schedDisplayMethod').textContent = (d.schedule.notify_method || 'whatsapp').toUpperCase();
        document.getElementById('scheduleDetails').style.display = 'block';
        document.getElementById('noScheduleInfo').style.display = 'none';
        document.getElementById('saveSchedBtn').textContent = 'üíæ Update Schedule';
      } else {
        currentSchedule = null;
        document.getElementById('scheduleBanner').classList.remove('active');
        document.getElementById('noScheduleBanner').classList.add('active');
        document.getElementById('scheduleDetails').style.display = 'none';
        document.getElementById('noScheduleInfo').style.display = 'block';
        document.getElementById('saveSchedBtn').textContent = 'üíæ Save Schedule';
      }
      
      renderHistory(d.history);
    });
}

function renderHistory(history) {
  var el = document.getElementById('historyList');
  if (!history || history.length === 0) {
    el.innerHTML = '<p style="color:#666">No calls yet</p>';
    return;
  }
  el.innerHTML = history.map(function(h) {
    var resultText = h.result === 'NO_TEST' ? '‚úÖ No Test' : (h.result === 'MUST_TEST' ? 'üö® Must Test' : '‚ö†Ô∏è Unknown');
    var date = new Date(h.created_at).toLocaleString();
    return '<div class="history-item"><div><div>' + date + '</div><small>PIN: ' + h.pin_used + '</small></div><span class="history-result ' + h.result + '">' + resultText + '</span></div>';
  }).join('');
}

function showTab(name) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.remove('active'); });
  document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.remove('active'); });
  event.target.classList.add('active');
  document.getElementById(name + 'Tab').classList.add('active');
}

var ws;
function connectWebSocket() {
  var proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(proto + '//' + location.host + '/ws');
  ws.onmessage = function(e) {
    var data = JSON.parse(e.data);
    if (data.type === 'log') {
      addConsoleEntry(data.log.message, data.log.type);
    }
    if (data.type === 'status') {
      addConsoleEntry('Call status: ' + data.status, 'info');
    }
    if (data.type === 'result') {
      var msg = data.result === 'NO_TEST' ? '‚úÖ No test today!' : (data.result === 'MUST_TEST' ? 'üö® TEST REQUIRED!' : '‚ö†Ô∏è Unknown result');
      addConsoleEntry(msg, data.result === 'NO_TEST' ? 'success' : (data.result === 'MUST_TEST' ? 'error' : 'warning'));
      var st = document.getElementById('callStatus');
      st.style.display = 'block';
      st.className = 'status ' + (data.result === 'NO_TEST' ? 'success' : (data.result === 'MUST_TEST' ? 'error' : 'warning'));
      st.textContent = msg;
      loadUser();
    }
  };
  ws.onclose = function() { setTimeout(connectWebSocket, 3000); };
}

function addConsoleEntry(msg, type) {
  var con = document.getElementById('console');
  var time = new Date().toLocaleTimeString();
  con.innerHTML += '<div class="console-entry ' + (type || 'info') + '"><span class="console-time">' + time + '</span>' + msg + '</div>';
  con.scrollTop = con.scrollHeight;
}

document.getElementById('callForm').onsubmit = function(e) {
  e.preventDefault();
  var btn = document.getElementById('callBtn');
  var st = document.getElementById('callStatus');
  
  btn.disabled = true;
  btn.textContent = 'Calling...';
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'üìû Initiating call...';
  document.getElementById('console').innerHTML = '';
  addConsoleEntry('Starting call...', 'info');
  
  var method = document.querySelector('input[name="notifyMethod"]:checked').value;
  
  fetch('/api/call', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({
      targetNumber: document.getElementById('targetNumber').value,
      pin: document.getElementById('pin').value,
      notifyNumber: document.getElementById('notifyNumber').value,
      notifyMethod: method
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.error) {
      st.className = 'status error';
      st.textContent = '‚ùå ' + d.error;
      addConsoleEntry('Error: ' + d.error, 'error');
    } else {
      addConsoleEntry('Call started! SID: ' + d.callSid, 'success');
    }
    btn.disabled = false;
    btn.textContent = 'üìû Call Now';
  })
  .catch(function(err) {
    st.className = 'status error';
    st.textContent = '‚ùå ' + err.message;
    btn.disabled = false;
    btn.textContent = 'üìû Call Now';
  });
};

document.getElementById('scheduleForm').onsubmit = function(e) {
  e.preventDefault();
  var method = document.querySelector('input[name="schedMethod"]:checked').value;
  var btn = document.getElementById('saveSchedBtn');
  btn.disabled = true;
  btn.textContent = 'Saving...';
  
  fetch('/api/schedule', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({
      targetNumber: document.getElementById('schedTarget').value,
      pin: document.getElementById('schedPin').value,
      notifyNumber: document.getElementById('schedNotify').value,
      notifyMethod: method,
      hour: parseInt(document.getElementById('schedHour').value),
      minute: parseInt(document.getElementById('schedMin').value),
      timezone: document.getElementById('schedTZ').value,
      enabled: true
    })
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.success) {
      alert('‚úÖ Schedule saved! Your call will run daily at the specified time.');
      loadUser();
    } else {
      alert('‚ùå Error saving schedule');
    }
    btn.disabled = false;
  });
};

function deleteSchedule() {
  if (!confirm('Are you sure you want to delete your schedule?')) return;
  
  fetch('/api/schedule', { method: 'DELETE', headers: { 'Authorization': 'Bearer ' + token } })
    .then(function(r) { return r.json(); })
    .then(function(d) {
      alert('Schedule deleted');
      loadUser();
    });
}

function testWhatsApp() {
  var num = document.getElementById('testNumber').value;
  if (!num) { alert('Enter a phone number'); return; }
  
  var st = document.getElementById('testStatus');
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'Sending WhatsApp...';
  
  fetch('/api/test-whatsapp', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ notifyNumber: num })
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.success) {
      st.className = 'status success';
      st.textContent = '‚úÖ WhatsApp sent! Check your phone.';
    } else {
      st.className = 'status error';
      st.textContent = '‚ùå Failed: ' + (d.error || 'Unknown error');
    }
  });
}

function testSMS() {
  var num = document.getElementById('testNumber').value;
  if (!num) { alert('Enter a phone number'); return; }
  
  var st = document.getElementById('testStatus');
  st.style.display = 'block';
  st.className = 'status calling';
  st.textContent = 'Sending SMS...';
  
  fetch('/api/test-sms', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
    body: JSON.stringify({ notifyNumber: num })
  })
  .then(function(r) { return r.json(); })
  .then(function(d) {
    if (d.success) {
      st.className = 'status success';
      st.textContent = '‚úÖ SMS sent! Check your phone.';
    } else {
      st.className = 'status error';
      st.textContent = '‚ùå Failed: ' + (d.error || 'Unknown error');
    }
  });
}

function logout() {
  supabase.auth.signOut().then(function() { window.location.href = '/'; });
}
</script>
</body>
</html>
