<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ProbationCall</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>*{box-sizing:border-box;margin:0;padding:0}body{font-family:-apple-system,sans-serif;background:#0a0a0f;color:#fff;min-height:100vh}.loading{display:flex;align-items:center;justify-content:center;height:100vh;font-size:1.2rem;color:#8892b0}.container{max-width:900px;margin:0 auto;padding:20px;display:none}nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1)}.logo{font-size:1.3rem;font-weight:700;color:#00d9ff}.logout-btn{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer}.credits-card{background:linear-gradient(135deg,#00d9ff,#00b4d8);border-radius:16px;padding:25px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:15px}.credits-num{font-size:2.5rem;font-weight:700;color:#0a0a0f}.credits-label{color:rgba(0,0,0,0.6)}.buy-btn{background:#0a0a0f;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:600;cursor:pointer}.card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:16px;padding:25px;margin-bottom:20px}.card h2{margin-bottom:20px;color:#00d9ff}.form-group{margin-bottom:15px}label{display:block;margin-bottom:5px;color:#8892b0}input,select{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff;font-size:1rem}.time-inputs{display:flex;gap:10px}.time-inputs input{width:80px}.btn{width:100%;padding:14px;border-radius:8px;border:none;background:linear-gradient(135deg,#00d9ff,#00b4d8);color:#0a0a0f;font-size:1rem;font-weight:600;cursor:pointer;margin-top:10px}.btn:disabled{opacity:0.5}.btn-danger{background:linear-gradient(135deg,#ff6b6b,#ff5252)}.status{padding:15px;border-radius:8px;margin-top:15px;text-align:center}.status.success{background:rgba(107,203,119,0.2);color:#6bcb77}.status.error{background:rgba(255,107,107,0.2);color:#ff6b6b}.status.calling{background:rgba(0,217,255,0.2);color:#00d9ff}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999;align-items:center;justify-content:center}.modal.show{display:flex}.modal-content{background:#1a1a2e;border-radius:16px;padding:30px;max-width:500px;width:90%}.modal h3{margin-bottom:20px;color:#00d9ff}.package{background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;margin-bottom:15px;cursor:pointer;transition:all 0.2s}.package:hover{background:rgba(0,217,255,0.1);border-color:#00d9ff}.package-name{font-size:1.2rem;font-weight:600;margin-bottom:5px}.package-price{color:#00d9ff;font-size:1.5rem;font-weight:700}.package-credits{color:#8892b0;font-size:0.9rem}.close-modal{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:8px 16px;border-radius:6px;cursor:pointer;margin-top:15px}.schedule-status{padding:10px;border-radius:8px;margin-bottom:15px;background:rgba(107,203,119,0.2);color:#6bcb77;text-align:center}</style>
</head>
<body>
  <div class="loading" id="loading">Loading...</div>
  <div class="container" id="app">
    <nav><div class="logo">üìû ProbationCall</div><button class="logout-btn" onclick="logout()">Sign Out (<span id="email"></span>)</button></nav>
    <div class="credits-card"><div><div class="credits-num" id="credits">0</div><div class="credits-label">Credits</div></div><button class="buy-btn" onclick="showBuyModal()">Buy Credits</button></div>
    
    <div class="card">
      <h2>‚è∞ Daily Schedule</h2>
      <div id="scheduleStatus" class="schedule-status" style="display:none"></div>
      <form onsubmit="saveSchedule(event)">
        <div class="form-group"><label>Hotline</label><input type="tel" id="schedTarget" placeholder="+19362834848" required></div>
        <div class="form-group"><label>6-Digit PIN</label><input type="text" id="schedPin" maxlength="6" placeholder="123456" required></div>
        <div class="form-group"><label>Your WhatsApp</label><input type="tel" id="schedNotify" placeholder="+1234567890" required></div>
        <div class="form-group">
          <label>Call Time (Daily)</label>
          <div class="time-inputs">
            <input type="number" id="schedHour" min="0" max="23" placeholder="Hour (0-23)" required>
            <input type="number" id="schedMinute" min="0" max="59" placeholder="Min (0-59)" required>
          </div>
        </div>
        <button type="submit" class="btn" id="schedBtn">üíæ Save Schedule</button>
        <button type="button" class="btn btn-danger" id="deleteSchedBtn" onclick="deleteSchedule()" style="display:none">üóëÔ∏è Delete Schedule</button>
      </form>
    </div>

    <div class="card">
      <h2>üìû Make a Call Now (1 Credit)</h2>
      <form onsubmit="makeCall(event)">
        <div class="form-group"><label>Hotline</label><input type="tel" id="target" value="+19362834848" required></div>
        <div class="form-group"><label>6-Digit PIN</label><input type="text" id="pin" maxlength="6" placeholder="123456" required></div>
        <div class="form-group"><label>Your WhatsApp</label><input type="tel" id="notify" placeholder="+1234567890" required></div>
        <button type="submit" class="btn" id="callBtn">üìû Call Now</button>
      </form>
      <div id="status" class="status" style="display:none"></div>
    </div>
  </div>
  
  <div class="modal" id="buyModal">
    <div class="modal-content">
      <h3>Buy Credits</h3>
      <div class="package" onclick="buyPackage('starter')">
        <div class="package-name">Starter</div>
        <div class="package-price">$9.99</div>
        <div class="package-credits">30 Credits</div>
      </div>
      <div class="package" onclick="buyPackage('standard')">
        <div class="package-name">Standard</div>
        <div class="package-price">$24.99</div>
        <div class="package-credits">90 Credits</div>
      </div>
      <div class="package" onclick="buyPackage('value')">
        <div class="package-name">Value</div>
        <div class="package-price">$39.99</div>
        <div class="package-credits">180 Credits</div>
      </div>
      <button class="close-modal" onclick="closeBuyModal()">Close</button>
    </div>
  </div>
  
<script>
const SUPA_URL='https://xvpuqeaowvlkcyywgaaq.supabase.co';
const SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cHVxZWFvd3Zsa2N5eXdnYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzc1MjcsImV4cCI6MjA3OTg1MzUyN30.y90odNDSU0zZcVGMK9C39gSFDL9NJcy5E4yBkgcFc8w';
const supabase=window.supabase.createClient(SUPA_URL,SUPA_KEY);
let accessToken=null;
let currentSchedule=null;

async function checkAuth(){const hash=window.location.hash;if(hash&&hash.includes('access_token')){await new Promise(r=>setTimeout(r,1000));history.replaceState(null,'',window.location.pathname+window.location.search);}const {data}=await supabase.auth.getSession();if(data.session){accessToken=data.session.access_token;showApp(data.session.user);const params=new URLSearchParams(window.location.search);if(params.get('success')==='true'){document.getElementById('status').style.display='block';document.getElementById('status').className='status success';document.getElementById('status').textContent='Payment successful! Credits added.';loadUserData();}}else{window.location.href='/login';}}

function showApp(user){document.getElementById('loading').style.display='none';document.getElementById('app').style.display='block';document.getElementById('email').textContent=user.email;loadUserData();}

async function loadUserData(){try{const r=await fetch('/api/user',{headers:{'Authorization':'Bearer '+accessToken}});const d=await r.json();document.getElementById('credits').textContent=d.profile?d.profile.credits:0;if(d.schedule){currentSchedule=d.schedule;document.getElementById('schedTarget').value=d.schedule.target_number;document.getElementById('schedPin').value=d.schedule.pin;document.getElementById('schedNotify').value=d.schedule.notify_number;document.getElementById('schedHour').value=d.schedule.hour;document.getElementById('schedMinute').value=d.schedule.minute;document.getElementById('deleteSchedBtn').style.display='block';document.getElementById('scheduleStatus').style.display='block';document.getElementById('scheduleStatus').textContent='‚úÖ Daily calls scheduled at '+d.schedule.hour+':'+String(d.schedule.minute).padStart(2,'0');}}catch(e){console.error(e);}}

async function saveSchedule(e){e.preventDefault();const btn=document.getElementById('schedBtn');btn.disabled=true;btn.textContent='Saving...';try{const r=await fetch('/api/schedule',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+accessToken},body:JSON.stringify({targetNumber:document.getElementById('schedTarget').value,pin:document.getElementById('schedPin').value,notifyNumber:document.getElementById('schedNotify').value,hour:parseInt(document.getElementById('schedHour').value),minute:parseInt(document.getElementById('schedMinute').value),enabled:true})});const d=await r.json();if(d.success){alert('‚úÖ Schedule saved! Calls will happen daily at the specified time.');loadUserData();}else{alert('Error: '+d.error);}}catch(err){alert('Error: '+err.message);}btn.disabled=false;btn.textContent='üíæ Save Schedule';}

async function deleteSchedule(){if(!confirm('Delete daily schedule?'))return;try{const r=await fetch('/api/schedule',{method:'DELETE',headers:{'Authorization':'Bearer '+accessToken}});const d=await r.json();if(d.success){alert('‚úÖ Schedule deleted');document.getElementById('schedTarget').value='';document.getElementById('schedPin').value='';document.getElementById('schedNotify').value='';document.getElementById('schedHour').value='';document.getElementById('schedMinute').value='';document.getElementById('deleteSchedBtn').style.display='none';document.getElementById('scheduleStatus').style.display='none';currentSchedule=null;}}catch(err){alert('Error: '+err.message);}}

function showBuyModal(){document.getElementById('buyModal').classList.add('show');}
function closeBuyModal(){document.getElementById('buyModal').classList.remove('show');}

async function buyPackage(packageId){try{const r=await fetch('/api/checkout',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+accessToken},body:JSON.stringify({packageId})});const d=await r.json();if(d.url){window.location.href=d.url;}else{alert('Error: '+d.error);}}catch(e){alert('Error: '+e.message);}}

async function makeCall(e){e.preventDefault();const btn=document.getElementById('callBtn');const st=document.getElementById('status');btn.disabled=true;btn.textContent='Calling...';st.style.display='block';st.className='status calling';st.textContent='Calling hotline...';try{const r=await fetch('/api/call',{method:'POST',headers:{'Content-Type':'application/json','Authorization':'Bearer '+accessToken},body:JSON.stringify({targetNumber:document.getElementById('target').value,pin:document.getElementById('pin').value,notifyNumber:document.getElementById('notify').value})});const d=await r.json();if(d.error){st.className='status error';st.textContent='Error: '+d.error;}else{st.className='status success';st.textContent='Call started! Check WhatsApp for results.';loadUserData();}}catch(err){st.className='status error';st.textContent='Error: '+err.message;}btn.disabled=false;btn.textContent='üìû Call Now';}

async function logout(){await supabase.auth.signOut();window.location.href='/';}

checkAuth();
</script>
</body>
</html>
