<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - ProbationCall</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#0a0a0f;color:#fff;min-height:100vh}
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;gap:15px}
.spinner{width:40px;height:40px;border:3px solid #333;border-top-color:#ef4444;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.container{max-width:1400px;margin:0 auto;padding:20px;display:none}
nav{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid rgba(255,255,255,0.1)}
.logo{font-size:1.3rem;font-weight:700;color:#ef4444}
.nav-right{display:flex;align-items:center;gap:10px}
.admin-badge{background:#ef4444;color:#fff;padding:4px 10px;border-radius:4px;font-size:0.75rem;font-weight:700}
.back-btn{background:rgba(255,255,255,0.1);border:none;color:#fff;padding:8px 14px;border-radius:6px;cursor:pointer;text-decoration:none}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:25px}
.stat-card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:18px;text-align:center}
.stat-num{font-size:1.8rem;font-weight:700;color:#00d9ff}
.stat-label{color:#8892b0;font-size:0.8rem;margin-top:5px}
.stat-card.green .stat-num{color:#22c55e}
.stat-card.orange .stat-num{color:#f59e0b}
.stat-card.red .stat-num{color:#ef4444}
.stat-card.purple .stat-num{color:#a78bfa}
.tabs{display:flex;gap:8px;margin-bottom:15px;flex-wrap:wrap}
.tab{padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#8892b0;cursor:pointer}
.tab.active{background:#ef4444;color:#fff;border-color:#ef4444}
.tab-content{display:none}
.tab-content.active{display:block}
.card{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;margin-bottom:15px}
.card h2{color:#00d9ff;margin-bottom:15px;font-size:1.1rem;display:flex;justify-content:space-between;align-items:center}
table{width:100%;border-collapse:collapse;font-size:0.85rem}
th,td{padding:10px 8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.05)}
th{color:#8892b0;font-weight:600;font-size:0.75rem;text-transform:uppercase}
.badge{padding:3px 8px;border-radius:12px;font-size:0.7rem;font-weight:600}
.badge.active{background:rgba(34,197,94,0.2);color:#22c55e}
.badge.disabled{background:rgba(239,68,68,0.2);color:#ef4444}
.badge.pending{background:rgba(245,158,11,0.2);color:#f59e0b}
.badge.admin{background:rgba(139,92,246,0.2);color:#a78bfa}
.badge.yes{background:rgba(34,197,94,0.2);color:#22c55e}
.badge.no{background:rgba(239,68,68,0.2);color:#ef4444}
.btn{padding:6px 12px;border-radius:6px;border:none;cursor:pointer;font-size:0.75rem;font-weight:600}
.btn-sm{padding:4px 8px;font-size:0.7rem}
.btn-primary{background:#00d9ff;color:#000}
.btn-danger{background:#ef4444;color:#fff}
.btn-success{background:#22c55e;color:#000}
.btn-warning{background:#f59e0b;color:#000}
.btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
.btn-purple{background:#a78bfa;color:#000}
.search-bar{display:flex;gap:10px;margin-bottom:15px}
.search-bar input{flex:1;padding:10px 15px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff}
.search-bar select{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff}
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:none;align-items:center;justify-content:center;z-index:100;padding:20px}
.modal.active{display:flex}
.modal-content{background:#1a1a2e;border-radius:16px;padding:25px;max-width:500px;width:100%}
.modal-close{float:right;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;color:#8892b0;font-size:0.85rem}
.form-group input,.form-group select{width:100%;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:#fff}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px}
.payout-card{background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.3);border-radius:12px;padding:15px;margin-bottom:10px}
.payout-amount{font-size:1.4rem;font-weight:700;color:#f59e0b}
.payout-actions{display:flex;gap:10px;margin-top:12px}
.access-denied{text-align:center;padding:100px 20px}
.access-denied h1{color:#ef4444}
.action-btns{display:flex;gap:5px;flex-wrap:wrap}
.text-muted{color:#666}
.text-green{color:#22c55e}
.mono{font-family:monospace}
</style>
</head>
<body>
<div class="loading" id="loading"><div class="spinner"></div><div style="color:#8892b0">Loading Admin...</div></div>
<div class="access-denied" id="accessDenied" style="display:none"><h1>Access Denied</h1><p style="color:#8892b0">Not an admin.</p><a href="/dashboard" class="btn btn-primary">Back</a></div>
<div class="container" id="app">
<nav><div class="logo">Admin Panel</div><div class="nav-right"><span class="admin-badge">ADMIN</span><span id="userEmail" style="color:#8892b0;font-size:0.85rem"></span><a href="/dashboard" class="back-btn">Dashboard</a></div></nav>
<div class="stats-grid">
<div class="stat-card"><div class="stat-num" id="statUsers">0</div><div class="stat-label">Total Users</div></div>
<div class="stat-card green"><div class="stat-num" id="statActive">0</div><div class="stat-label">Active Schedules</div></div>
<div class="stat-card"><div class="stat-num" id="statCalls">0</div><div class="stat-label">Total Calls</div></div>
<div class="stat-card green"><div class="stat-num" id="statRevenue">$0</div><div class="stat-label">Revenue</div></div>
<div class="stat-card orange"><div class="stat-num" id="statPending">0</div><div class="stat-label">Pending Payouts</div></div>
<div class="stat-card orange"><div class="stat-num" id="statOwed">$0</div><div class="stat-label">Affiliate Owed</div></div>
<div class="stat-card purple"><div class="stat-num" id="statTerms">0</div><div class="stat-label">Terms Agreed</div></div>
<div class="stat-card red"><div class="stat-num" id="statDisabled">0</div><div class="stat-label">Disabled</div></div>
</div>
<div class="tabs">
<div class="tab active" onclick="showTab('users')">Users</div>
<div class="tab" onclick="showTab('payouts')">Payouts</div>
<div class="tab" onclick="showTab('purchases')">Purchases</div>
<div class="tab" onclick="showTab('calls')">Calls</div>
<div class="tab" onclick="showTab('promos')">Promos</div>
</div>
<div id="usersTab" class="tab-content active"><div class="card"><h2>All Users <button class="btn btn-sm btn-secondary" onclick="loadDashboard()">Refresh</button></h2><div class="search-bar"><input type="text" id="userSearch" placeholder="Search..." onkeyup="filterUsers()"><select id="userFilter" onchange="filterUsers()"><option value="all">All</option><option value="active">Active</option><option value="disabled">Disabled</option><option value="admin">Admins</option><option value="scheduled">Scheduled</option></select></div><div style="max-height:500px;overflow-y:auto"><table><thead><tr><th>Email</th><th>Credits</th><th>Ref Code</th><th>Affiliate</th><th>Terms</th><th>Status</th><th>Last Login</th><th>Actions</th></tr></thead><tbody id="usersTable"></tbody></table></div></div></div>
<div id="payoutsTab" class="tab-content"><div class="card"><h2>Pending Payouts</h2><div id="pendingPayouts"></div></div></div>
<div id="purchasesTab" class="tab-content"><div class="card"><h2>Purchases</h2><table><thead><tr><th>User</th><th>Package</th><th>Amount</th><th>Date</th></tr></thead><tbody id="purchasesTable"></tbody></table></div></div>
<div id="callsTab" class="tab-content"><div class="card"><h2>Calls</h2><table><thead><tr><th>User</th><th>Result</th><th>Date</th></tr></thead><tbody id="callsTable"></tbody></table></div></div>
<div id="promosTab" class="tab-content"><div class="card"><h2>Promos <button class="btn btn-sm btn-primary" onclick="showPromoModal()">+ New</button></h2><table><thead><tr><th>Code</th><th>Credits</th><th>Used/Max</th><th>Actions</th></tr></thead><tbody id="promosTable"></tbody></table></div></div>
</div>
<div class="modal" id="creditsModal"><div class="modal-content"><button class="modal-close" onclick="closeModal('creditsModal')">&times;</button><h2 style="margin-bottom:20px">Manage Credits</h2><p style="color:#8892b0;margin-bottom:15px">User: <span id="creditsUserEmail" style="color:#fff"></span> (Current: <span id="creditsUserCurrent" style="color:#00d9ff"></span>)</p><form onsubmit="submitCredits(event)"><input type="hidden" id="creditsUserId"><div class="form-row"><div class="form-group"><label>Action</label><select id="creditsAction"><option value="add">Add</option><option value="remove">Remove</option><option value="set">Set To</option></select></div><div class="form-group"><label>Amount</label><input type="number" id="creditsAmount" min="0" value="10" required></div></div><button type="submit" class="btn btn-success" style="width:100%;padding:12px">Apply</button></form></div></div>
<div class="modal" id="promoModal"><div class="modal-content"><button class="modal-close" onclick="closeModal('promoModal')">&times;</button><h2 style="margin-bottom:20px">Create Promo</h2><form onsubmit="createPromo(event)"><div class="form-group"><label>Code</label><input type="text" id="newPromoCode" required style="text-transform:uppercase"></div><div class="form-row"><div class="form-group"><label>Credits</label><input type="number" id="newPromoCredits" min="1" value="5" required></div><div class="form-group"><label>Max Uses</label><input type="number" id="newPromoMax" min="1" value="100" required></div></div><button type="submit" class="btn btn-primary" style="width:100%;padding:12px">Create</button></form></div></div>
<script>
var SUPA_URL='https://xvpuqeaowvlkcyywgaaq.supabase.co';
var SUPA_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2cHVxZWFvd3Zsa2N5eXdnYWFxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyNzc1MjcsImV4cCI6MjA3OTg1MzUyN30.y90odNDSU0zZcVGMK9C39gSFDL9NJcy5E4yBkgcFc8w';
var supabase=window.supabase.createClient(SUPA_URL,SUPA_KEY);
var token=null;
var allUsers=[];
var allSchedules=[];

async function init(){
  var r=await supabase.auth.getSession();
  if(!r.data.session){window.location.href='/login';return;}
  token=r.data.session.access_token;
  var chk=await fetch('/api/admin/check',{headers:{Authorization:'Bearer '+token}}).then(function(r){return r.json()});
  if(!chk.isAdmin){
    document.getElementById('loading').style.display='none';
    document.getElementById('accessDenied').style.display='block';
    return;
  }
  document.getElementById('loading').style.display='none';
  document.getElementById('app').style.display='block';
  document.getElementById('userEmail').textContent=r.data.session.user.email;
  loadDashboard();
}

async function loadDashboard(){
  var d=await fetch('/api/admin/dashboard',{headers:{Authorization:'Bearer '+token}}).then(function(r){return r.json()});
  if(d.error){alert('Error: '+d.error);return;}
  document.getElementById('statUsers').textContent=d.stats.totalUsers;
  document.getElementById('statActive').textContent=d.stats.activeSchedules;
  document.getElementById('statCalls').textContent=d.stats.totalCalls;
  document.getElementById('statRevenue').textContent='$'+(d.stats.totalRevenue/100).toFixed(2);
  document.getElementById('statPending').textContent=d.stats.pendingPayouts;
  document.getElementById('statOwed').textContent='$'+(d.stats.affiliateOwed/100).toFixed(2);
  document.getElementById('statTerms').textContent=d.stats.termsAgreed;
  document.getElementById('statDisabled').textContent=d.stats.disabledUsers;
  allUsers=d.users;
  allSchedules=d.schedules;
  renderUsers(allUsers);
  renderPayouts(d.payouts);
  renderPurchases(d.purchases);
  renderCalls(d.calls);
  renderPromos(d.promos);
}

function renderUsers(users){
  var h='';
  for(var i=0;i<users.length;i++){
    var u=users[i];
    var sched=null;
    for(var j=0;j<allSchedules.length;j++){if(allSchedules[j].user_id===u.id){sched=allSchedules[j];break;}}
    var status=u.is_disabled?'<span class="badge disabled">Disabled</span>':'<span class="badge active">Active</span>';
    if(u.is_admin){status+=' <span class="badge admin">Admin</span>';}
    if(sched){status+=' <span class="badge yes">Sched</span>';}
    var terms=u.terms_accepted_at?'<span class="badge yes">Yes</span>':'<span class="badge no">No</span>';
    var lastLogin=u.last_login?timeAgo(u.last_login):'Never';
    var aff=((u.affiliate_balance_cents||0)/100).toFixed(2);
    h+='<tr>';
    h+='<td>'+u.email+'</td>';
    h+='<td>'+(u.credits||0)+'</td>';
    h+='<td class="mono">'+(u.referral_code||'-')+'</td>';
    h+='<td>$'+aff+'</td>';
    h+='<td>'+terms+'</td>';
    h+='<td>'+status+'</td>';
    h+='<td>'+lastLogin+'</td>';
    h+='<td><div class="action-btns">';
    h+='<button class="btn btn-sm btn-secondary" onclick="showCreditsModal(\''+u.id+'\',\''+u.email+'\','+(u.credits||0)+')">Credits</button>';
    if(u.is_admin){
      h+='<button class="btn btn-sm btn-warning" onclick="toggleAdmin(\''+u.id+'\',false)">-Admin</button>';
    }else{
      h+='<button class="btn btn-sm btn-purple" onclick="toggleAdmin(\''+u.id+'\',true)">+Admin</button>';
    }
    if(u.is_disabled){
      h+='<button class="btn btn-sm btn-success" onclick="toggleDisabled(\''+u.id+'\',false)">Enable</button>';
    }else{
      h+='<button class="btn btn-sm btn-danger" onclick="toggleDisabled(\''+u.id+'\',true)">Disable</button>';
    }
    h+='</div></td>';
    h+='</tr>';
  }
  document.getElementById('usersTable').innerHTML=h||'<tr><td colspan="8" class="text-muted">No users</td></tr>';
}

function filterUsers(){
  var s=document.getElementById('userSearch').value.toLowerCase();
  var f=document.getElementById('userFilter').value;
  var filtered=[];
  for(var i=0;i<allUsers.length;i++){
    var u=allUsers[i];
    var m=u.email.toLowerCase().indexOf(s)>=0;
    if(!m)continue;
    if(f==='active'&&u.is_disabled)continue;
    if(f==='disabled'&&!u.is_disabled)continue;
    if(f==='admin'&&!u.is_admin)continue;
    if(f==='scheduled'){
      var hasSched=false;
      for(var j=0;j<allSchedules.length;j++){if(allSchedules[j].user_id===u.id){hasSched=true;break;}}
      if(!hasSched)continue;
    }
    filtered.push(u);
  }
  renderUsers(filtered);
}

function renderPayouts(payouts){
  var pending=[];
  for(var i=0;i<payouts.length;i++){if(payouts[i].status==='pending')pending.push(payouts[i]);}
  var ph='';
  if(pending.length===0){
    ph='<p class="text-muted">No pending payouts</p>';
  }else{
    for(var i=0;i<pending.length;i++){
      var p=pending[i];
      ph+='<div class="payout-card">';
      ph+='<div class="payout-amount">$'+(p.amount_cents/100).toFixed(2)+' <span class="badge pending">Pending</span></div>';
      ph+='<div style="color:#8892b0;margin:10px 0">User: '+(p.user_email||'Unknown')+' | PayPal: '+p.payout_email+'</div>';
      ph+='<div class="payout-actions">';
      ph+='<button class="btn btn-success" onclick="processPayout(\''+p.id+'\',\'paid\')">Mark Paid</button>';
      ph+='<button class="btn btn-danger" onclick="processPayout(\''+p.id+'\',\'rejected\')">Reject</button>';
      ph+='</div></div>';
    }
  }
  document.getElementById('pendingPayouts').innerHTML=ph;
}

function renderPurchases(purchases){
  var h='';
  for(var i=0;i<purchases.length;i++){
    var p=purchases[i];
    h+='<tr><td>'+(p.user_email||'Unknown')+'</td><td>'+p.package_name+'</td><td class="text-green">$'+(p.amount_cents/100).toFixed(2)+'</td><td>'+new Date(p.created_at).toLocaleDateString()+'</td></tr>';
  }
  document.getElementById('purchasesTable').innerHTML=h||'<tr><td colspan="4" class="text-muted">No purchases</td></tr>';
}

function renderCalls(calls){
  var h='';
  var max=calls.length>100?100:calls.length;
  for(var i=0;i<max;i++){
    var c=calls[i];
    var rc=c.result==='NO_TEST'?'active':c.result==='MUST_TEST'?'disabled':'pending';
    h+='<tr><td>'+(c.user_email||'Unknown')+'</td><td><span class="badge '+rc+'">'+c.result+'</span></td><td>'+new Date(c.created_at).toLocaleString()+'</td></tr>';
  }
  document.getElementById('callsTable').innerHTML=h||'<tr><td colspan="3" class="text-muted">No calls</td></tr>';
}

function renderPromos(promos){
  var h='';
  for(var i=0;i<promos.length;i++){
    var p=promos[i];
    h+='<tr><td class="mono" style="color:#00d9ff;font-weight:700">'+p.code+'</td><td>'+p.credits+'</td><td>'+p.times_used+'/'+p.max_uses+'</td><td><button class="btn btn-sm btn-danger" onclick="deletePromo(\''+p.id+'\')">Delete</button></td></tr>';
  }
  document.getElementById('promosTable').innerHTML=h||'<tr><td colspan="4" class="text-muted">No promos</td></tr>';
}

function showTab(name){
  var tabs=document.querySelectorAll('.tab');
  var contents=document.querySelectorAll('.tab-content');
  for(var i=0;i<tabs.length;i++){tabs[i].classList.remove('active');}
  for(var i=0;i<contents.length;i++){contents[i].classList.remove('active');}
  event.target.classList.add('active');
  document.getElementById(name+'Tab').classList.add('active');
}

function showCreditsModal(uid,email,current){
  document.getElementById('creditsUserId').value=uid;
  document.getElementById('creditsUserEmail').textContent=email;
  document.getElementById('creditsUserCurrent').textContent=current;
  document.getElementById('creditsAmount').value=10;
  document.getElementById('creditsModal').classList.add('active');
}

function submitCredits(e){
  e.preventDefault();
  var uid=document.getElementById('creditsUserId').value;
  var action=document.getElementById('creditsAction').value;
  var amount=parseInt(document.getElementById('creditsAmount').value);
  fetch('/api/admin/user/'+uid+'/credits',{
    method:'POST',
    headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},
    body:JSON.stringify({action:action,amount:amount})
  }).then(function(){
    closeModal('creditsModal');
    loadDashboard();
    alert('Credits updated!');
  });
}

function toggleAdmin(uid,makeAdmin){
  if(!confirm(makeAdmin?'Make admin?':'Remove admin?'))return;
  fetch('/api/admin/user/'+uid+'/admin',{
    method:'POST',
    headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},
    body:JSON.stringify({isAdmin:makeAdmin})
  }).then(function(){loadDashboard();});
}

function toggleDisabled(uid,disable){
  if(!confirm(disable?'Disable user?':'Enable user?'))return;
  fetch('/api/admin/user/'+uid+'/disable',{
    method:'POST',
    headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},
    body:JSON.stringify({disabled:disable})
  }).then(function(){loadDashboard();});
}

function processPayout(pid,status){
  if(!confirm('Mark as '+status+'?'))return;
  fetch('/api/admin/payout/'+pid,{
    method:'POST',
    headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},
    body:JSON.stringify({status:status})
  }).then(function(){loadDashboard();});
}

function showPromoModal(){
  document.getElementById('newPromoCode').value='';
  document.getElementById('promoModal').classList.add('active');
}

function createPromo(e){
  e.preventDefault();
  fetch('/api/admin/promo',{
    method:'POST',
    headers:{'Content-Type':'application/json',Authorization:'Bearer '+token},
    body:JSON.stringify({
      code:document.getElementById('newPromoCode').value.toUpperCase(),
      credits:parseInt(document.getElementById('newPromoCredits').value),
      maxUses:parseInt(document.getElementById('newPromoMax').value)
    })
  }).then(function(){
    closeModal('promoModal');
    loadDashboard();
    alert('Promo created!');
  });
}

function deletePromo(pid){
  if(!confirm('Delete?'))return;
  fetch('/api/admin/promo/'+pid,{
    method:'DELETE',
    headers:{Authorization:'Bearer '+token}
  }).then(function(){loadDashboard();});
}

function closeModal(id){document.getElementById(id).classList.remove('active');}

function timeAgo(d){
  var s=Math.floor((Date.now()-new Date(d))/1000);
  if(s<60)return s+'s';
  if(s<3600)return Math.floor(s/60)+'m';
  if(s<86400)return Math.floor(s/3600)+'h';
  return Math.floor(s/86400)+'d';
}

init();
</script>
</body>
</html>
